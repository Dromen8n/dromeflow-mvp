<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DromeFlow - Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Biblioteca XLSX para processamento de planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- CSS Centralizado do DromeFlow -->
    <link rel="stylesheet" href="css/main.css">
    
</head>
<body>
    <div class="app-container">
        <!-- Header Global -->
        <header class="global-header">
            <div class="header-left">
                <div class="logo-brand">
                    <img src="https://iili.io/3RBGZox.png" alt="DromeFlow Logo" class="logo-img">
                </div>
            </div>
            <div class="header-main">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <select id="unitSelect" class="db-title-select">
                    <option value="">Selecione uma unidade</option>
                    <!-- Op√ß√µes ser√£o preenchidas via JS -->
                </select>
            </div>
            <div class="header-center">
                <div class="filters-container">
                    <label class="filter-label text-text-secondary">M√™s</label>
                    <select id="monthFilter" class="db-title-select filter-select ml-2">
                        <option value="">Todos</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                    <label class="filter-label text-text-secondary">Ano</label>
                    <select id="yearFilter" class="db-title-select filter-select ml-2">
                        <option value="">Todos</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
            </div>
            <div class="header-right">
                <button id="uploadXlsxBtn" class="btn btn-sm btn-outline btn-icon-only" onclick="abrirModalUpload()" title="Upload XLSX">
                    <i class="fas fa-upload"></i>
                </button>
                <button id="refreshBtn" class="btn btn-sm btn-outline btn-icon-only" title="Atualizar">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="headerThemeToggle" class="btn btn-sm btn-outline btn-icon-only" title="Alternar tema claro/escuro">
                    <i class="fas fa-moon"></i>
                </button>
                <!-- Bot√£o de Sair -->
                <button id="logoutBtn" class="btn btn-sm btn-danger btn-icon-only" title="Sair" onclick="logout().catch(console.error)">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <!-- Navega√ß√£o -->
                <nav class="sidebar-nav">
                    <!-- Menu Gest√£o -->
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-menu="gestao">
                            <i class="nav-icon fas fa-cog"></i>
                            <span class="nav-text">Menu Gest√£o</span>
                            <i class="nav-arrow fas fa-chevron-right"></i>
                        </a>
                        <div class="submenu" id="submenu-gestao">
                            <div class="submenu-item">
                                <a href="#" class="submenu-link" data-module="unidade">
                                    <span>Unidade</span>
                                </a>
                            </div>
                            <div class="submenu-item">
                                <a href="#" class="submenu-link" data-module="clientes">
                                    <span>Clientes</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard -->
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="dashboard">
                            <i class="nav-icon fas fa-chart-pie"></i>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </div>

                    <!-- Agenda -->
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="agenda">
                            <i class="nav-icon fas fa-calendar-alt"></i>
                            <span class="nav-text">Agenda</span>
                        </a>
                    </div>

                    <!-- P√≥s-Venda -->
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="pos-venda">
                            <i class="nav-icon fas fa-handshake"></i>
                            <span class="nav-text">P√≥s-Venda</span>
                        </a>
                    </div>

                    <!-- Recrutamento -->
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="recrutamento">
                            <i class="nav-icon fas fa-users"></i>
                            <span class="nav-text">Recrutamento</span>
                        </a>
                    </div>
                </nav>

                <!-- Footer da Sidebar -->
                <div class="sidebar-footer">
                    <div class="user-info">
                        <div class="user-avatar">
                            U
                        </div>
                        <div class="user-details">
                            <div class="user-name">Usu√°rio</div>
                            <div class="user-role">Fa√ßa login</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Conte√∫do Principal -->
            <main class="main-content">
                <!-- √Årea de Conte√∫do -->
                <div class="content-area" id="contentArea">
                    <div class="welcome-container">
                        <div class="welcome-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h2 class="welcome-title">
                            Bem-vindo ao DromeFlow
                        </h2>
                        <p class="welcome-description">
                            Sistema de gest√£o completo para sua empresa. Utilize o menu lateral para navegar entre os m√≥dulos dispon√≠veis.
                        </p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Login -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-modal">
            <div class="logo-container">
                <img src="https://iili.io/3IVuaEb.png" alt="DromeFlow Logo">
            </div>
            <h2>Acesso ao Sistema</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email" placeholder="Digite seu e-mail" required>
                </div>
                <div class="input-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" name="password" placeholder="Digite sua senha" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">Entrar</button>
                
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </form>
        </div>
    </div>

    <!-- Modal de Upload XLSX -->
    <div class="modal-backdrop hidden" id="uploadModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload de Arquivo XLSX</h3>
                <button type="button" class="btn-close" onclick="closeUploadModal()" title="Fechar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="dropZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p class="upload-text">
                        Arraste e solte seu arquivo XLSX aqui
                    </p>
                    <p class="upload-separator">ou</p>
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('xlsxInput').click()">
                        <i class="fas fa-folder-open"></i>
                        Selecionar Arquivo
                    </button>
                    <input type="file" id="xlsxInput" accept=".xlsx" class="hidden-input">
                    <div class="upload-info">
                        <p><strong>Formatos aceitos:</strong> .xlsx</p>
                        <p><strong>Tamanho m√°ximo:</strong> 10MB</p>
                    </div>
                </div>
                
                <div class="upload-preview hidden" id="uploadPreview">
                    <div class="file-info">
                        <i class="fas fa-file-excel"></i>
                        <div class="file-details">
                            <div class="file-name" id="fileName"></div>
                            <div class="file-size" id="fileInfo"></div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="clearFileSelection()" title="Remover arquivo">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="upload-status hidden" id="uploadStatus">
                    <div class="status-message" id="statusMessage"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="processFile" onclick="processUploadedFile()" disabled>
                    <i class="fas fa-cogs"></i>
                    Processar Arquivo
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://etztlxlfgoqbgwyaozwf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0enRseGxmZ29xYmd3eWFvendmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMzE2NDAsImV4cCI6MjA2ODkwNzY0MH0.gGDCHoMv3J3La2h7QCItNS56Xs-UrhaNa6M_jFZ9w9I';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Estado da aplica√ß√£o
        let currentUser = null;
        let userUnits = [];
        let userRole = null; // Papel do usu√°rio (super_admin, admin, user)
        let availableModules = []; // M√≥dulos que o usu√°rio pode acessar
        let unitModules = []; // M√≥dulos dispon√≠veis na unidade (para admins)
        
        // Cache para templates carregados
        const templateCache = new Map();
        
        // Listener para m√≥dulos carregados - Sistema aprimorado
        document.addEventListener('moduleLoaded', function(e) {
            const { module, templatePath, fromCache, timestamp } = e.detail;
            console.log(`‚úÖ M√≥dulo "${module}" inicializado com sucesso ${fromCache ? '(cache)' : '(novo)'}`);
            
            // Sistema de inicializa√ß√£o modular aprimorado
            const moduleInitializers = {
                'dashboard': initializeDashboard,
                'clientes': initializeClientes, 
                'agenda': initializeAgenda,
                'unidade': initializeUnidade,
                'pos-venda': initializePosVenda,
                'recrutamento': initializeRecrutamento
                // Removido 'gestao-sistema' para usar template HTML
            };

            // Executar inicializador espec√≠fico se existir
            if (moduleInitializers[module]) {
                try {
                    moduleInitializers[module]();
                } catch (error) {
                    console.error(`‚ùå Erro ao inicializar m√≥dulo "${module}":`, error);
                }
            } else {
                console.warn(`‚ö†Ô∏è Inicializador n√£o encontrado para o m√≥dulo "${module}"`);
            }

            // Disparar evento global de m√≥dulo pronto
            document.dispatchEvent(new CustomEvent('moduleReady', {
                detail: { module, timestamp: new Date().toISOString() }
            }));
        });

        // Fun√ß√µes de inicializa√ß√£o espec√≠ficas dos m√≥dulos
        function initializeDashboard() {
            console.log('üìä Dashboard inicializado');
            
            // Configurar listeners para filtros do dashboard
            setupDashboardFilters();
            
            // Inicializar submenu padr√£o (Geral)
            setTimeout(() => {
                loadDashboardSubmenu('geral');
            }, 100);
            
            console.log('‚úÖ Dashboard pronto para uso');
        }

        // Fun√ß√£o para carregar submenu do dashboard
        function loadDashboardSubmenu(submenu) {
            console.log('[Dashboard] Carregando submenu:', submenu);
            
            // Ocultar todas as se√ß√µes
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Mostrar se√ß√£o selecionada
            const targetSection = document.getElementById(`dashboard-${submenu}`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                
                // Atualizar t√≠tulo e breadcrumb
                updateDashboardHeader(submenu);
                
                // Carregar dados espec√≠ficos da se√ß√£o
                if (submenu === 'geral') {
                    loadDashboardGeral();
                } else if (submenu === 'clientes') {
                    loadDashboardClientes();
                }
            }
        }

        // Atualizar header do dashboard
        function updateDashboardHeader(submenu) {
            const pageTitle = document.getElementById('pageTitle');
            
            const configs = {
                geral: {
                    title: 'Dashboard - Geral'
                },
                clientes: {
                    title: 'Dashboard - Clientes'
                }
            };
            
            const config = configs[submenu];
            if (config && pageTitle) {
                pageTitle.textContent = config.title;
            }
        }

        // Limpar submenu do header
        function clearHeaderSubmenu() {
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = 'Dashboard';
            }
        }

        // Carregar dados da se√ß√£o Geral
        function loadDashboardGeral() {
            console.log('[Dashboard] Carregando se√ß√£o Geral');
            loadDashboardData();
        }

        // Carregar dados da se√ß√£o Clientes
        function loadDashboardClientes() {
            console.log('[Dashboard] Carregando se√ß√£o Clientes');
            // Carregar dados espec√≠ficos de clientes
            loadClientData();
        }

        // Fun√ß√£o global para navega√ß√£o externa
        window.loadDashboardSubmenu = loadDashboardSubmenu;

        // Fun√ß√£o para carregar submenu de Gest√£o do Sistema
        function loadGestaoSistemaSubmenu(submenu) {
            console.log('[Gest√£o Sistema] Carregando submenu:', submenu);
            
            // Ocultar todas as se√ß√µes
            const gestaoSections = document.querySelectorAll('.gestao-section');
            console.log('[DEBUG] Se√ß√µes encontradas:', gestaoSections.length);
            gestaoSections.forEach(section => {
                console.log('[DEBUG] Ocultando se√ß√£o:', section.id);
                section.classList.add('hidden');
            });
            
            // Mostrar se√ß√£o selecionada
            const targetSection = document.getElementById(`gestao-${submenu}`);
            console.log('[DEBUG] Procurando se√ß√£o:', `gestao-${submenu}`);
            console.log('[DEBUG] Se√ß√£o encontrada:', targetSection);
            
            if (targetSection) {
                console.log('[DEBUG] Removendo classe hidden da se√ß√£o:', targetSection.id);
                targetSection.classList.remove('hidden');
                
                // Verificar se realmente foi removida
                console.log('[DEBUG] Classes ap√≥s remo√ß√£o:', targetSection.className);
                console.log('[DEBUG] Display computado:', window.getComputedStyle(targetSection).display);
                
                // Atualizar t√≠tulo e breadcrumb
                updateGestaoSistemaHeader(submenu);
                
                // Carregar dados espec√≠ficos da se√ß√£o
                if (submenu === 'unidades') {
                    loadUnidades();
                } else if (submenu === 'administradores') {
                    loadAdministradores();
                }
            } else {
                console.error('[ERRO] Se√ß√£o n√£o encontrada:', `gestao-${submenu}`);
                console.log('[DEBUG] Se√ß√µes dispon√≠veis:');
                document.querySelectorAll('[id^="gestao-"]').forEach(el => {
                    console.log(' -', el.id);
                });
            }
        }

        // Atualizar header da gest√£o do sistema
        function updateGestaoSistemaHeader(submenu) {
            const pageTitle = document.getElementById('pageTitle');
            
            const configs = {
                unidades: {
                    title: 'Gest√£o do Sistema - Unidades'
                },
                administradores: {
                    title: 'Gest√£o do Sistema - Administradores'
                }
            };
            
            const config = configs[submenu];
            if (config && pageTitle) {
                pageTitle.textContent = config.title;
            }
        }

        // Fun√ß√£o global para navega√ß√£o externa
        window.loadGestaoSistemaSubmenu = loadGestaoSistemaSubmenu;

        // Fun√ß√µes para carregar dados das se√ß√µes de Gest√£o do Sistema
        async function loadUnidades() {
            console.log('[Gest√£o Sistema] Carregando dados das unidades do banco de dados');
            
            const tableBody = document.getElementById('unitsTableBody');
            if (!tableBody) {
                console.error('‚ùå Elemento unitsTableBody n√£o encontrado');
                return;
            }

            // Mostrar loading
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando unidades...
                        </div>
                    </td>
                </tr>
            `;

            try {
                // Buscar unidades do banco de dados
                const { data: units, error } = await supabase
                    .from('units')
                    .select('*')
                    .eq('is_active', true)
                    .order('name', { ascending: true });

                if (error) {
                    console.error('‚ùå Erro ao carregar unidades:', error);
                    throw error;
                }

                console.log('üìä Unidades carregadas:', units?.length || 0);

                if (!units || units.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="empty-state-content">
                                    <i class="fas fa-building empty-state-icon"></i>
                                    <h3>Nenhuma unidade encontrada</h3>
                                    <p>N√£o h√° unidades cadastradas no sistema.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Carregar dados adicionais para cada unidade
                const unitsWithStats = await Promise.all(units.map(async (unit) => {
                    try {
                        // Contar administradores
                        const { data: adminCount } = await supabase
                            .from('user_units')
                            .select('user_id', { count: 'exact' })
                            .eq('unit_id', unit.id);

                        // Contar m√≥dulos ativos
                        const { data: moduleCount } = await supabase
                            .from('unit_modules')
                            .select('module_id', { count: 'exact' })
                            .eq('unit_id', unit.id);

                        return {
                            ...unit,
                            adminCount: adminCount?.length || 0,
                            moduleCount: moduleCount?.length || 0
                        };
                    } catch (error) {
                        console.error(`‚ùå Erro ao carregar stats para unidade ${unit.name}:`, error);
                        return {
                            ...unit,
                            adminCount: 0,
                            moduleCount: 0
                        };
                    }
                }));

                // Preencher tabela com dados reais
                tableBody.innerHTML = unitsWithStats.map(unit => `
                    <tr onclick="viewUnitDetails('${unit.id}')" class="clickable-row">
                        <td>${unit.name}</td>
                        <td>${unit.adminCount} administrador${unit.adminCount !== 1 ? 'es' : ''}</td>
                        <td>${unit.moduleCount} m√≥dulo${unit.moduleCount !== 1 ? 's' : ''}</td>
                        <td>
                            <span class="badge badge-${unit.is_active ? 'success' : 'warning'}">
                                ${unit.is_active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                    </tr>
                `).join('');

                console.log('‚úÖ Tabela de unidades atualizada com dados reais');

            } catch (error) {
                console.error('‚ùå Erro ao carregar unidades:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="error-state-content">
                                <i class="fas fa-exclamation-triangle error-state-icon"></i>
                                <h3>Erro ao carregar unidades</h3>
                                <p>Ocorreu um erro ao carregar os dados. Tente novamente.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        async function loadAdministradores() {
            console.log('[Gest√£o Sistema] Carregando dados dos administradores do banco de dados');
            
            const tableBody = document.getElementById('adminsTableBody');
            if (!tableBody) {
                console.error('‚ùå Elemento adminsTableBody n√£o encontrado');
                return;
            }

            // Mostrar loading
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <div class="loading">
                            <div class="spinner"></div>
                            Carregando administradores...
                        </div>
                    </td>
                </tr>
            `;

            try {
                // Buscar administradores do banco de dados (usu√°rios com role = 'admin')
                const { data: admins, error } = await supabase
                    .from('users')
                    .select(`
                        id,
                        email,
                        created_at,
                        role_id,
                        roles (
                            name
                        )
                    `)
                    .eq('roles.name', 'admin')  // Buscar pelo nome do role
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Erro ao carregar administradores:', error);
                    throw error;
                }

                console.log('üìä Administradores carregados:', admins?.length || 0);

                if (!admins || admins.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-state-content">
                                    <i class="fas fa-user-shield empty-state-icon"></i>
                                    <h3>Nenhum administrador encontrado</h3>
                                    <p>N√£o h√° administradores cadastrados no sistema.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Carregar unidades para cada administrador
                const adminsWithUnits = await Promise.all(admins.map(async (admin) => {
                    try {
                        // Buscar unidades do administrador
                        const { data: userUnits } = await supabase
                            .from('user_units')
                            .select(`
                                units (
                                    id,
                                    name
                                )
                            `)
                            .eq('user_id', admin.id);

                        const units = userUnits?.map(uu => uu.units.name).join(', ') || 'Nenhuma unidade';

                        return {
                            ...admin,
                            unitsNames: units,
                            unitsCount: userUnits?.length || 0
                        };
                    } catch (error) {
                        console.error(`‚ùå Erro ao carregar unidades para admin ${admin.email}:`, error);
                        return {
                            ...admin,
                            unitsNames: 'Erro ao carregar',
                            unitsCount: 0
                        };
                    }
                }));

                // Preencher tabela com dados reais
                tableBody.innerHTML = adminsWithUnits.map(admin => {
                    const createdDate = new Date(admin.created_at).toLocaleDateString('pt-BR');
                    // Assumir que todos os administradores est√£o ativos por padr√£o (j√° que n√£o temos is_active)
                    const statusBadge = '<span class="badge badge-success">Ativo</span>';

                    return `
                        <tr onclick="openAdminCard('${admin.id}')" class="clickable-row">
                            <td>${admin.email}</td>
                            <td>${admin.unitsNames}</td>
                            <td>${createdDate}</td>
                            <td>${statusBadge}</td>
                            <td onclick="event.stopPropagation();">
                                <button class="btn btn-sm btn-warning" onclick="editAdmin('${admin.id}')">
                                    <i class="fas fa-edit"></i>
                                    Editar
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                console.log('‚úÖ Tabela de administradores atualizada com dados reais');

            } catch (error) {
                console.error('‚ùå Erro ao carregar administradores:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="error-state-content">
                                <i class="fas fa-exclamation-triangle error-state-icon"></i>
                                <h3>Erro ao carregar administradores</h3>
                                <p>Ocorreu um erro ao carregar os dados. Tente novamente.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Fun√ß√µes auxiliares para Gest√£o do Sistema
        async function openAdminCard(adminId) {
            console.log('[Admin Card] Carregando dados do administrador:', adminId);
            
            const card = document.getElementById('adminInfoCard');
            if (!card) {
                console.error('‚ùå Elemento adminInfoCard n√£o encontrado');
                return;
            }

            try {
                // Mostrar loading no card
                card.style.display = 'block';
                document.getElementById('adminEmailInfo').textContent = 'Carregando...';
                document.getElementById('adminUnitsInfo').textContent = 'Carregando...';
                document.getElementById('adminCreatedAtInfo').textContent = 'Carregando...';
                document.getElementById('adminStatusInfo').innerHTML = 'Carregando...';

                // Buscar dados completos do administrador com role
                const { data: admin, error: adminError } = await supabase
                    .from('users')
                    .select(`
                        id,
                        email,
                        created_at,
                        role_id,
                        roles (name, display_name)
                    `)
                    .eq('id', adminId)
                    .single();

                if (adminError) {
                    console.error('‚ùå Erro ao carregar dados do administrador:', adminError);
                    throw adminError;
                }

                // Buscar unidades do administrador
                const { data: adminUnits, error: unitsError } = await supabase
                    .from('user_units')
                    .select(`
                        unit_id,
                        units (
                            id,
                            name
                        )
                    `)
                    .eq('user_id', adminId);

                if (unitsError) {
                    console.error('‚ùå Erro ao carregar unidades do administrador:', unitsError);
                    throw unitsError;
                }

                // üîß NOVO: Buscar permiss√µes de m√≥dulos concedidas pelo admin
                const { data: modulePermissions, error: permissionsError } = await supabase
                    .from('user_module_permissions')
                    .select(`
                        user_id,
                        unit_id,
                        module_id,
                        granted_at,
                        users (
                            id,
                            email,
                            created_at,
                            role_id,
                            roles (name, display_name)
                        ),
                        units (
                            id,
                            name
                        ),
                        modules (
                            id,
                            name,
                            display_name,
                            icon
                        )
                    `)
                    .eq('granted_by', adminId)
                    .order('granted_at', { ascending: false });

                if (permissionsError) {
                    console.error('‚ùå Erro ao carregar permiss√µes de m√≥dulos:', permissionsError);
                    // N√£o falhar por este erro, apenas mostrar mensagem
                }

                // Preencher informa√ß√µes b√°sicas
                document.getElementById('adminEmailInfo').textContent = admin.email || 'N/A';
                document.getElementById('adminCreatedAtInfo').textContent = admin.created_at 
                    ? new Date(admin.created_at).toLocaleDateString('pt-BR')
                    : 'N/A';
                
                // Status sempre ativo
                document.getElementById('adminStatusInfo').innerHTML = 
                    '<span class="badge badge-success">Ativo</span>';

                // Preencher unidades do administrador
                if (adminUnits && adminUnits.length > 0) {
                    const unitNames = adminUnits
                        .map(uu => uu.units?.name || 'Unidade desconhecida')
                        .join(', ');
                    document.getElementById('adminUnitsInfo').textContent = unitNames;
                } else {
                    document.getElementById('adminUnitsInfo').textContent = 'Nenhuma unidade vinculada';
                }

                // üîß NOVO: Preencher lista de usu√°rios criados com m√≥dulos liberados
                const usersList = document.getElementById('adminUsersList');
                if (usersList) {
                    if (modulePermissions && modulePermissions.length > 0) {
                        // Agrupar permiss√µes por usu√°rio
                        const userPermissionsMap = new Map();
                        
                        modulePermissions.forEach(permission => {
                            const userId = permission.user_id;
                            
                            if (!userPermissionsMap.has(userId)) {
                                userPermissionsMap.set(userId, {
                                    user: permission.users,
                                    permissions: []
                                });
                            }
                            
                            userPermissionsMap.get(userId).permissions.push({
                                unit: permission.units,
                                module: permission.modules,
                                granted_at: permission.granted_at
                            });
                        });

                        // Gerar HTML para cada usu√°rio
                        usersList.innerHTML = Array.from(userPermissionsMap.entries()).map(([userId, userData]) => {
                            const user = userData.user;
                            const permissions = userData.permissions;
                            
                            const roleName = user.roles?.display_name || 'Usu√°rio';
                            const createdDate = user.created_at 
                                ? new Date(user.created_at).toLocaleDateString('pt-BR')
                                : 'N/A';
                            
                            // Agrupar permiss√µes por unidade
                            const unitGroups = new Map();
                            permissions.forEach(perm => {
                                const unitId = perm.unit.id;
                                if (!unitGroups.has(unitId)) {
                                    unitGroups.set(unitId, {
                                        unit: perm.unit,
                                        modules: []
                                    });
                                }
                                unitGroups.get(unitId).modules.push(perm.module);
                            });

                            // Gerar lista de unidades e m√≥dulos
                            const unitsModulesHTML = Array.from(unitGroups.entries()).map(([unitId, unitData]) => {
                                const unit = unitData.unit;
                                const modules = unitData.modules;
                                
                                const modulesHTML = modules.map(module => 
                                    `<span class="module-badge">
                                        <i class="${module.icon || 'fas fa-cube'}"></i> ${module.display_name || module.name}
                                    </span>`
                                ).join('');
                                
                                return `
                                    <div class="unit-modules-container">
                                        <div class="unit-title">
                                            üìç ${unit.name}
                                        </div>
                                        <div class="modules-list">
                                            ${modulesHTML}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            return `
                                <div class="user-item">
                                    <!-- Header do Usu√°rio -->
                                    <div class="user-header">
                                        <div class="user-main-info">
                                            <div class="user-name">>
                                                üë§ ${user.email}
                                            </div>
                                            <div class="user-email">
                                                ${roleName}
                                            </div>
                                        </div>
                                        <div class="user-date">
                                            Criado em:<br>
                                            <strong>${createdDate}</strong>
                                        </div>
                                    </div>
                                    
                                    <!-- Permiss√µes do Usu√°rio -->
                                    <div class="user-permissions">
                                        <div class="permissions-title">
                                            üîë M√≥dulos Liberados:
                                        </div>
                                        ${unitsModulesHTML}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                    } else {
                        usersList.innerHTML = `
                            <div class="empty-state-admin">
                                <i class="fas fa-user-shield empty-state-icon"></i>
                                <p class="empty-state-title">
                                    Nenhuma permiss√£o de m√≥dulo foi concedida por este administrador ainda.
                                </p>
                                <p class="empty-state-subtitle">
                                    Quando este admin liberar m√≥dulos para usu√°rios, eles aparecer√£o aqui organizados por unidade.
                                </p>
                            </div>
                        `;
                    }
                }

                console.log('‚úÖ Dados do administrador e permiss√µes carregados com sucesso');

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do administrador:', error);
                
                // Mostrar erro na interface
                const errorMessage = error.message || 'Erro desconhecido ao carregar dados';
                document.getElementById('adminEmailInfo').textContent = 'Erro ao carregar';
                document.getElementById('adminUnitsInfo').textContent = 'Erro ao carregar';
                document.getElementById('adminCreatedAtInfo').textContent = 'Erro ao carregar';
                document.getElementById('adminStatusInfo').innerHTML = 
                    '<span class="badge badge-danger">Erro</span>';
                
                const usersList = document.getElementById('adminUsersList');
                if (usersList) {
                    usersList.innerHTML = `
                        <div class="error-message-container">
                            <i class="fas fa-exclamation-triangle error-icon"></i>
                            <p>Erro ao carregar dados: ${errorMessage}</p>
                            <button onclick="openAdminCard('${adminId}')" class="admin-open-button">
                                Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }
        }

        function closeAdminCard() {
            const card = document.getElementById('adminInfoCard');
            if (card) {
                card.style.display = 'none';
            }
        }

        function editAdmin(adminId) {
            console.log('[Gest√£o Sistema] Editando administrador:', adminId);
            // TODO: Implementar modal de edi√ß√£o
        }

        function openAdminModal() {
            console.log('[Gest√£o Sistema] Abrindo modal para novo administrador');
            const modal = document.getElementById('adminModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // Fun√ß√£o para visualizar detalhes da unidade
        async function viewUnitDetails(unitId) {
            console.log('[Gest√£o Sistema] Visualizando detalhes da unidade:', unitId);
            
            try {
                // Buscar dados completos da unidade
                const { data: unit, error: unitError } = await supabase
                    .from('units')
                    .select('*')
                    .eq('id', unitId)
                    .single();

                if (unitError) {
                    console.error('‚ùå Erro ao carregar dados da unidade:', unitError);
                    throw unitError;
                }

                // Buscar administradores da unidade
                const { data: unitAdmins, error: adminsError } = await supabase
                    .from('user_units')
                    .select(`
                        users (
                            id,
                            email,
                            is_active
                        )
                    `)
                    .eq('unit_id', unitId);

                if (adminsError) {
                    console.error('‚ùå Erro ao carregar administradores da unidade:', adminsError);
                }

                // Buscar m√≥dulos da unidade
                const { data: unitModules, error: modulesError } = await supabase
                    .from('unit_modules')
                    .select(`
                        modules (
                            id,
                            name,
                            display_name,
                            icon
                        )
                    `)
                    .eq('unit_id', unitId);

                if (modulesError) {
                    console.error('‚ùå Erro ao carregar m√≥dulos da unidade:', modulesError);
                }

                // Por enquanto, apenas log dos dados - depois pode implementar um modal
                console.log('üìä Detalhes da unidade:', {
                    unit,
                    admins: unitAdmins?.map(ua => ua.users) || [],
                    modules: unitModules?.map(um => um.modules) || []
                });

                // TODO: Implementar modal ou card de detalhes da unidade
                alert(`Detalhes da unidade: ${unit.name}\nAdministradores: ${unitAdmins?.length || 0}\nM√≥dulos: ${unitModules?.length || 0}`);

            } catch (error) {
                console.error('‚ùå Erro ao visualizar detalhes da unidade:', error);
                alert('Erro ao carregar detalhes da unidade. Tente novamente.');
            }
        }

        // Configurar filtros do dashboard
        function setupDashboardFilters() {
            const unitSelect = document.getElementById('unitSelect');
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            console.log('üîß Configurando listeners dos filtros do dashboard');
            
            // Listener para mudan√ßa de unidade
            if (unitSelect) {
                unitSelect.addEventListener('change', (e) => {
                    console.log('üîÑ Unidade alterada:', e.target.value);
                    setTimeout(() => loadDashboardData(), 100);
                });
            }
            
            // üîß CORRE√á√ÉO: Listener para mudan√ßa de m√™s
            if (monthFilter) {
                monthFilter.addEventListener('change', (e) => {
                    console.log('üîÑ M√™s alterado:', e.target.value);
                    const monthName = e.target.selectedOptions[0]?.textContent || 'Todos';
                    console.log('üìÖ Nome do m√™s:', monthName);
                    
                    // For√ßar recarregamento dos dados com novo filtro
                    setTimeout(() => {
                        console.log('üîÑ Recarregando dados do dashboard ap√≥s mudan√ßa de m√™s...');
                        loadDashboardData();
                    }, 100);
                });
            }
            
            // üîß CORRE√á√ÉO: Listener para mudan√ßa de ano
            if (yearFilter) {
                yearFilter.addEventListener('change', (e) => {
                    console.log('üîÑ Ano alterado:', e.target.value);
                    
                    // For√ßar recarregamento dos dados com novo filtro
                    setTimeout(() => {
                        console.log('üîÑ Recarregando dados do dashboard ap√≥s mudan√ßa de ano...');
                        loadDashboardData();
                    }, 100);
                });
            }
            
            console.log('‚úÖ Event listeners dos filtros configurados');
        }

        // Carregar dados do dashboard
        async function loadDashboardData() {
            const unitSelect = document.getElementById('unitSelect');
            const selectedUnit = unitSelect?.value;
            
            if (!selectedUnit) {
                console.log('‚ö†Ô∏è Nenhuma unidade selecionada');
                clearDashboardData();
                return;
            }
            
            console.log('üìä Carregando dados do dashboard para unidade:', selectedUnit);
            
            try {
                // Obter filtros de data
                const filters = getDashboardFilters();
                
                // Carregar m√©tricas principais
                await loadMainMetrics(selectedUnit, filters);
                
                // Carregar dados para gr√°fico
                await loadChartData(selectedUnit, filters);
                
                // Carregar dados de clientes
                await loadClientData(selectedUnit, filters);
                
                console.log('‚úÖ Dados do dashboard carregados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do dashboard:', error);
                showDashboardError('Erro ao carregar dados do dashboard');
            }
        }

        // Obter filtros de data atuais
        function getDashboardFilters() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            const filters = {
                month: monthFilter?.value || null,
                year: yearFilter?.value || new Date().getFullYear().toString()
            };
            
            // üîß CORRE√á√ÉO: Log detalhado dos filtros
            console.log('üîç Filtros atuais obtidos:', {
                month: filters.month,
                monthText: monthFilter?.selectedOptions[0]?.textContent,
                year: filters.year,
                yearText: yearFilter?.selectedOptions[0]?.textContent
            });
            
            return filters;
        }

        // Carregar m√©tricas principais
        async function loadMainMetrics(unitId, filters) {
            try {
                console.log('üìä Carregando m√©tricas com filtros:', filters);
                
                let query = supabase
                    .from('resultados')
                    .select('*')
                    .eq('unit_id', unitId);
                
                // üîß CORRE√á√ÉO: Aplicar filtros de data corretamente
                if (filters.year) {
                    if (filters.month) {
                        // Filtro espec√≠fico de m√™s e ano
                        const month = filters.month.padStart(2, '0');
                        const startDate = `${filters.year}-${month}-01`;
                        
                        // Calcular √∫ltimo dia do m√™s
                        const lastDay = new Date(filters.year, parseInt(filters.month), 0).getDate();
                        const endDate = `${filters.year}-${month}-${lastDay.toString().padStart(2, '0')}`;
                        
                        console.log('üóìÔ∏è Aplicando filtro de m√™s:', { startDate, endDate, month: filters.month, year: filters.year });
                        query = query.gte('data', startDate).lte('data', endDate);
                    } else {
                        // Apenas filtro de ano
                        console.log('üóìÔ∏è Aplicando filtro de ano:', filters.year);
                        query = query.gte('data', `${filters.year}-01-01`);
                        query = query.lte('data', `${filters.year}-12-31`);
                    }
                }
                
                const { data: resultados, error } = await query;
                
                if (error) {
                    console.error('‚ùå Erro na query:', error);
                    throw error;
                }
                
                console.log('üìä Resultados carregados com filtros:', {
                    total: resultados?.length || 0,
                    filters: filters,
                    amostra: resultados?.slice(0, 3)
                });
                
                // üîß NOVO: Carregar dados do per√≠odo anterior para compara√ß√£o
                const previousPeriodData = await loadPreviousPeriodData(unitId, filters);
                
                // Calcular m√©tricas
                const metrics = calculateMetrics(resultados || [], filters, previousPeriodData);
                
                // Atualizar interface
                updateMetricCards(metrics);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar m√©tricas:', error);
                throw error;
            }
        }

        // üîß NOVA: Fun√ß√£o para carregar dados do per√≠odo anterior
        async function loadPreviousPeriodData(unitId, filters) {
            try {
                let query = supabase
                    .from('resultados')
                    .select('*')
                    .eq('unit_id', unitId);
                
                // Calcular per√≠odo anterior baseado nos filtros
                if (filters.year) {
                    if (filters.month) {
                        // M√™s anterior
                        const currentMonth = parseInt(filters.month);
                        const currentYear = parseInt(filters.year);
                        
                        const prevMonth = currentMonth === 1 ? 12 : currentMonth - 1;
                        const prevYear = currentMonth === 1 ? currentYear - 1 : currentYear;
                        
                        const month = prevMonth.toString().padStart(2, '0');
                        const startDate = `${prevYear}-${month}-01`;
                        const lastDay = new Date(prevYear, prevMonth, 0).getDate();
                        const endDate = `${prevYear}-${month}-${lastDay.toString().padStart(2, '0')}`;
                        
                        console.log('üóìÔ∏è Carregando per√≠odo anterior (m√™s):', { startDate, endDate });
                        query = query.gte('data', startDate).lte('data', endDate);
                    } else {
                        // Ano anterior
                        const prevYear = parseInt(filters.year) - 1;
                        console.log('üóìÔ∏è Carregando per√≠odo anterior (ano):', prevYear);
                        query = query.gte('data', `${prevYear}-01-01`);
                        query = query.lte('data', `${prevYear}-12-31`);
                    }
                }
                
                const { data: previousData, error } = await query;
                
                if (error) {
                    console.error('‚ùå Erro ao carregar per√≠odo anterior:', error);
                    return [];
                }
                
                console.log('üìä Dados do per√≠odo anterior carregados:', previousData?.length || 0);
                return previousData || [];
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do per√≠odo anterior:', error);
                return [];
            }
        }

        // Calcular m√©tricas dos dados
        function calculateMetrics(resultados, filters, previousPeriodData = []) {
            console.log('üìä Calculando m√©tricas com filtros:', filters);
            console.log('üìä Dados recebidos j√° filtrados:', resultados?.length || 0);
            console.log('üìä Dados per√≠odo anterior:', previousPeriodData?.length || 0);
            
            // üîß CORRE√á√ÉO CR√çTICA: Os dados j√° v√™m filtrados da query, n√£o filtrar novamente
            // Usar os dados diretamente como per√≠odo selecionado
            const selectedPeriod = resultados || [];
            const previousPeriod = previousPeriodData || [];
            
            console.log('üìÖ Per√≠odo selecionado (dados j√° filtrados):', {
                total: selectedPeriod.length,
                filters: filters,
                amostra: selectedPeriod.slice(0, 3)
            });
            
            // Filtros para esta semana (sempre atual para contexto)
            const now = new Date();
            const today = new Date();
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            const endOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            
            const thisWeek = selectedPeriod.filter(r => {
                const data = new Date(r.data);
                return data >= startOfWeek && data <= endOfWeek;
            });
            
            // Semana anterior
            const lastWeekStart = new Date(startOfWeek);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            const lastWeekEnd = new Date(endOfWeek);
            lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);
            
            const lastWeek = selectedPeriod.filter(r => {
                const data = new Date(r.data);
                return data >= lastWeekStart && data <= lastWeekEnd;
            });
            
            // Calcular totais do per√≠odo selecionado (dados j√° filtrados)
            const totalAtendimentos = selectedPeriod.length;
            const totalFaturamento = selectedPeriod.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0);
            const clientesUnicos = new Set(selectedPeriod.map(r => r.cliente).filter(c => c)).size;
            const atendimentosSemana = thisWeek.length;
            
            // Calcular compara√ß√µes com per√≠odo anterior
            const previousAtendimentos = previousPeriod.length;
            const previousFaturamento = previousPeriod.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0);
            const previousClientes = new Set(previousPeriod.map(r => r.cliente).filter(c => c)).size;
            const lastWeekAtendimentos = lastWeek.length;
            
            console.log('üìà M√©tricas calculadas (SEM dupla filtragem):', {
                periodo: filters?.month ? `${filters.month}/${filters.year}` : filters.year,
                atendimentos: totalAtendimentos,
                faturamento: totalFaturamento,
                clientes: clientesUnicos,
                semana: atendimentosSemana,
                comparacao: {
                    atendimentos: previousAtendimentos,
                    faturamento: previousFaturamento,
                    clientes: previousClientes
                }
            });
            
            return {
                atendimentos: {
                    total: totalAtendimentos,
                    comparison: calculatePercentageChange(totalAtendimentos, previousAtendimentos)
                },
                faturamento: {
                    total: totalFaturamento,
                    comparison: calculatePercentageChange(totalFaturamento, previousFaturamento)
                },
                clientes: {
                    total: clientesUnicos,
                    comparison: calculatePercentageChange(clientesUnicos, previousClientes)
                },
                semana: {
                    total: atendimentosSemana,
                    comparison: calculatePercentageChange(atendimentosSemana, lastWeekAtendimentos)
                }
            };
        }

        // Calcular mudan√ßa percentual
        function calculatePercentageChange(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return Math.round(((current - previous) / previous) * 100);
        }

        // Atualizar cards de m√©tricas
        function updateMetricCards(metrics) {
            // Atendimentos
            const totalAtendimentos = document.getElementById('total-atendimentos');
            const compAtendimentos = document.getElementById('comp-atendimentos');
            if (totalAtendimentos) totalAtendimentos.textContent = metrics.atendimentos.total.toLocaleString();
            if (compAtendimentos) updateComparisonElement(compAtendimentos, metrics.atendimentos.comparison);
            
            // Faturamento
            const totalFaturamento = document.getElementById('total-faturamento');
            const compFaturamento = document.getElementById('comp-faturamento');
            if (totalFaturamento) totalFaturamento.textContent = `R$ ${metrics.faturamento.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            if (compFaturamento) updateComparisonElement(compFaturamento, metrics.faturamento.comparison);
            
            // Clientes
            const totalClientes = document.getElementById('total-clientes');
            const compClientes = document.getElementById('comp-clientes');
            if (totalClientes) totalClientes.textContent = metrics.clientes.total.toLocaleString();
            if (compClientes) updateComparisonElement(compClientes, metrics.clientes.comparison);
            
            // Semana
            const totalSemana = document.getElementById('total-semana');
            const compSemana = document.getElementById('comp-semana');
            if (totalSemana) totalSemana.textContent = metrics.semana.total.toLocaleString();
            if (compSemana) updateComparisonElement(compSemana, metrics.semana.comparison);
        }

        // Atualizar elemento de compara√ß√£o
        function updateComparisonElement(element, percentage) {
            const icon = element.querySelector('i');
            const span = element.querySelector('span');
            
            if (percentage > 0) {
                icon.className = 'fas fa-caret-up';
                span.textContent = `+${percentage}%`;
                element.style.color = 'var(--success-color)';
            } else if (percentage < 0) {
                icon.className = 'fas fa-caret-down';
                span.textContent = `${percentage}%`;
                element.style.color = 'var(--danger-color)';
            } else {
                icon.className = 'fas fa-equals';
                span.textContent = '0%';
                element.style.color = 'var(--text-secondary)';
            }
        }

        // Carregar dados para gr√°fico
        async function loadChartData(unitId, filters) {
            // Implementar gr√°fico de atendimentos por dia
            console.log('üìä Carregando dados do gr√°fico...');
            // TODO: Implementar gr√°fico com Chart.js ou similar
        }

        // Carregar dados de clientes
        async function loadClientData(unitId, filters) {
            try {
                let query = supabase
                    .from('resultados')
                    .select('cliente, data, whatscliente, valor')
                    .eq('unit_id', unitId)
                    .not('cliente', 'is', null);
                
                // Aplicar filtros de data
                if (filters.year) {
                    query = query.gte('data', `${filters.year}-01-01`);
                    query = query.lte('data', `${filters.year}-12-31`);
                }
                
                if (filters.month) {
                    const month = filters.month.padStart(2, '0');
                    query = query.gte('data', `${filters.year}-${month}-01`);
                    
                    const lastDay = new Date(filters.year, filters.month, 0).getDate();
                    query = query.lte('data', `${filters.year}-${month}-${lastDay}`);
                }
                
                const { data: clienteData, error } = await query.order('data', { ascending: false });
                
                if (error) throw error;
                
                // Processar dados de clientes
                const processedClients = processClientData(clienteData || []);
                
                // Atualizar tabelas de clientes
                updateClientTables(processedClients);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados de clientes:', error);
                throw error;
            }
        }

        // Processar dados de clientes
        function processClientData(data) {
            const clientMap = new Map();
            
            data.forEach(record => {
                const cliente = record.cliente;
                if (!clientMap.has(cliente)) {
                    clientMap.set(cliente, {
                        nome: cliente,
                        telefone: record.whatscliente || 'N/A',
                        ultimoAtendimento: record.data,
                        totalAtendimentos: 0,
                        valorTotal: 0,
                        registros: []
                    });
                }
                
                const clientInfo = clientMap.get(cliente);
                clientInfo.totalAtendimentos++;
                clientInfo.valorTotal += parseFloat(record.valor) || 0;
                clientInfo.registros.push(record);
                
                // Atualizar √∫ltimo atendimento (mais recente)
                if (new Date(record.data) > new Date(clientInfo.ultimoAtendimento)) {
                    clientInfo.ultimoAtendimento = record.data;
                }
            });
            
            const clientes = Array.from(clientMap.values());
            
            // Classificar clientes
            const now = new Date();
            const clientesAtivos = clientes.filter(c => {
                const diasSemAtendimento = Math.floor((now - new Date(c.ultimoAtendimento)) / (1000 * 60 * 60 * 24));
                return diasSemAtendimento <= 30;
            });
            
            const clientesRecorrentes = clientes.filter(c => c.totalAtendimentos >= 3);
            
            const clientesAtencao = clientes.filter(c => {
                const diasSemAtendimento = Math.floor((now - new Date(c.ultimoAtendimento)) / (1000 * 60 * 60 * 24));
                return diasSemAtendimento > 30 && diasSemAtendimento <= 90;
            });
            
            return {
                todos: clientes,
                ativos: clientesAtivos,
                recorrentes: clientesRecorrentes,
                atencao: clientesAtencao
            };
        }

        // Atualizar tabelas de clientes
        function updateClientTables(clientesData) {
            // Atualizar contadores nos filter cards
            const filterTotalValue = document.getElementById('filter-total-value');
            const filterRecorrentesValue = document.getElementById('filter-recorrentes-value');
            const filterAtencaoValue = document.getElementById('filter-atencao-value');
            const filterOutrosValue = document.getElementById('filter-outros-value');
            
            if (filterTotalValue) filterTotalValue.textContent = clientesData.todos.length;
            if (filterRecorrentesValue) filterRecorrentesValue.textContent = clientesData.recorrentes.length;
            if (filterAtencaoValue) filterAtencaoValue.textContent = clientesData.atencao.length;
            if (filterOutrosValue) filterOutrosValue.textContent = Math.max(0, clientesData.todos.length - clientesData.recorrentes.length - clientesData.atencao.length);
            
            // Popular tabela de clientes ativos (padr√£o)
            populateClientTable('tabela-clientes-ativos', clientesData.ativos, 'ativo');
        }

        // Popular tabela de clientes
        function populateClientTable(tableId, clientes, tipo) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            clientes.slice(0, 10).forEach(cliente => { // Limitar a 10 para performance
                const row = document.createElement('tr');
                
                const ultimoAtendimento = new Date(cliente.ultimoAtendimento).toLocaleDateString('pt-BR');
                const diasSemAtendimento = Math.floor((new Date() - new Date(cliente.ultimoAtendimento)) / (1000 * 60 * 60 * 24));
                
                let statusBadge = '';
                if (tipo === 'ativo') {
                    statusBadge = '<span class="status-badge-table status-active">Ativo</span>';
                } else if (tipo === 'recorrente') {
                    statusBadge = '<span class="status-badge-table status-recurrent">Recorrente</span>';
                } else if (tipo === 'atencao') {
                    statusBadge = '<span class="status-badge-table status-attention">Aten√ß√£o</span>';
                }
                
                row.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.telefone}</td>
                    <td>${ultimoAtendimento}</td>
                    <td>${tipo === 'atencao' ? `${diasSemAtendimento} dias` : (tipo === 'recorrente' ? `${cliente.totalAtendimentos} atendimentos` : statusBadge)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewClientDetails('${cliente.nome}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Limpar dados do dashboard
        function clearDashboardData() {
            // Zerar m√©tricas
            const elements = [
                'total-atendimentos', 'total-faturamento', 'total-clientes', 'total-semana',
                'filter-total-value', 'filter-recorrentes-value', 'filter-atencao-value', 'filter-outros-value'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = '0';
            });
            
            // Limpar compara√ß√µes
            const comparisons = ['comp-atendimentos', 'comp-faturamento', 'comp-clientes', 'comp-semana'];
            comparisons.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const icon = element.querySelector('i');
                    const span = element.querySelector('span');
                    if (icon) icon.className = 'fas fa-equals';
                    if (span) span.textContent = '0%';
                    element.style.color = 'var(--text-secondary)';
                }
            });
            
            // Limpar tabelas
            const tables = ['tabela-clientes-ativos', 'tabela-clientes-recorrentes', 'tabela-clientes-atencao'];
            tables.forEach(id => {
                const table = document.getElementById(id);
                if (table) {
                    const tbody = table.querySelector('tbody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="table-empty-message">Selecione uma unidade para ver os dados</td></tr>';
                }
            });
        }

        // Mostrar erro no dashboard
        function showDashboardError(message) {
            console.error('‚ùå Erro no dashboard:', message);
            // TODO: Implementar notifica√ß√£o de erro
        }

        // Fun√ß√£o global para ver detalhes do cliente
        window.viewClientDetails = function(clientName) {
            console.log('üëÅÔ∏è Visualizando detalhes do cliente:', clientName);
            // TODO: Implementar modal de detalhes do cliente
        };

        // üîß NOVA: Fun√ß√£o para debug dos filtros de m√™s do Dashboard
        window.debugDashboardMonthFilter = function(testMonth, testYear) {
            console.log('üîç === DEBUG FILTRO DE M√äS DO DASHBOARD ===');
            
            const unitSelect = document.getElementById('unitSelect');
            const selectedUnit = unitSelect?.value;
            
            if (!selectedUnit) {
                console.error('‚ùå Nenhuma unidade selecionada');
                return;
            }
            
            console.log('üè¢ Unidade selecionada:', selectedUnit);
            
            // Simular filtros
            const testFilters = {
                month: testMonth || '6', // Junho como exemplo
                year: testYear || '2025'
            };
            
            console.log('üìÖ Testando filtros:', testFilters);
            
            // Testar a query manualmente
            loadMainMetrics(selectedUnit, testFilters).then(() => {
                console.log('‚úÖ Teste de filtro conclu√≠do');
            }).catch(error => {
                console.error('‚ùå Erro no teste:', error);
            });
        };

        // üîß NOVA: Fun√ß√£o para verificar dados brutos por m√™s
        window.checkRawDataByMonth = async function(unitId, month, year) {
            console.log('üîç === VERIFICANDO DADOS BRUTOS ===');
            
            const unitSelect = document.getElementById('unitSelect');
            const selectedUnit = unitId || unitSelect?.value;
            
            if (!selectedUnit) {
                console.error('‚ùå Nenhuma unidade selecionada');
                return;
            }
            
            try {
                // Query sem filtros de data
                const { data: allData, error: allError } = await supabase
                    .from('resultados')
                    .select('*')
                    .eq('unit_id', selectedUnit);
                
                if (allError) throw allError;
                
                console.log('üìä Total de registros na unidade:', allData?.length || 0);
                
                // Agrupar por m√™s/ano
                const groupedByMonth = {};
                allData?.forEach(record => {
                    const date = new Date(record.data);
                    const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!groupedByMonth[key]) {
                        groupedByMonth[key] = [];
                    }
                    groupedByMonth[key].push(record);
                });
                
                console.log('üìÖ Dados por m√™s/ano:', Object.keys(groupedByMonth).sort().map(key => ({
                    periodo: key,
                    registros: groupedByMonth[key].length,
                    valores: groupedByMonth[key].reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0)
                })));
                
                // Testar filtro espec√≠fico se fornecido
                if (month && year) {
                    const testMonth = month.toString().padStart(2, '0');
                    const startDate = `${year}-${testMonth}-01`;
                    const lastDay = new Date(year, month, 0).getDate();
                    const endDate = `${year}-${testMonth}-${lastDay.toString().padStart(2, '0')}`;
                    
                    const { data: filteredData, error: filterError } = await supabase
                        .from('resultados')
                        .select('*')
                        .eq('unit_id', selectedUnit)
                        .gte('data', startDate)
                        .lte('data', endDate);
                    
                    if (filterError) throw filterError;
                    
                    console.log(`üéØ Dados filtrados para ${testMonth}/${year}:`, {
                        query: { startDate, endDate },
                        resultados: filteredData?.length || 0,
                        registros: filteredData?.slice(0, 3)
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar dados brutos:', error);
            }
        };

        // üîß NOVA: Fun√ß√£o para testar contagem atual vs filtrada
        window.testCurrentCounting = async function() {
            console.log('üîç === TESTE DE CONTAGEM ATUAL ===');
            
            const unitSelect = document.getElementById('unitSelect');
            const selectedUnit = unitSelect?.value;
            
            if (!selectedUnit) {
                console.error('‚ùå Nenhuma unidade selecionada');
                return;
            }
            
            // Obter filtros atuais
            const filters = getDashboardFilters();
            console.log('üîç Filtros atuais:', filters);
            
            try {
                // Simular a mesma query da fun√ß√£o loadMainMetrics
                let query = supabase
                    .from('resultados')
                    .select('*')
                    .eq('unit_id', selectedUnit);
                
                if (filters.year) {
                    if (filters.month) {
                        const month = filters.month.padStart(2, '0');
                        const startDate = `${filters.year}-${month}-01`;
                        const lastDay = new Date(filters.year, parseInt(filters.month), 0).getDate();
                        const endDate = `${filters.year}-${month}-${lastDay.toString().padStart(2, '0')}`;
                        
                        console.log('üóìÔ∏è Query com filtro de m√™s:', { startDate, endDate });
                        query = query.gte('data', startDate).lte('data', endDate);
                    } else {
                        console.log('üóìÔ∏è Query com filtro de ano:', filters.year);
                        query = query.gte('data', `${filters.year}-01-01`);
                        query = query.lte('data', `${filters.year}-12-31`);
                    }
                }
                
                const { data: queryResults, error } = await query;
                
                if (error) throw error;
                
                console.log('üìä Resultados da query:', {
                    total: queryResults?.length || 0,
                    amostra: queryResults?.slice(0, 5).map(r => ({ data: r.data, valor: r.valor, cliente: r.cliente }))
                });
                
                // Comparar com valor mostrado na interface
                const totalAtendimentosElement = document.getElementById('total-atendimentos');
                const valorInterface = totalAtendimentosElement?.textContent;
                
                console.log('üîç Compara√ß√£o:', {
                    queryResult: queryResults?.length || 0,
                    interfaceValue: valorInterface,
                    saoIguais: (queryResults?.length || 0).toString() === valorInterface
                });
                
                if ((queryResults?.length || 0).toString() !== valorInterface) {
                    console.warn('‚ö†Ô∏è DISCREP√ÇNCIA ENCONTRADA! A interface n√£o est√° mostrando o valor correto.');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
            }
        };

        // üîß NOVA: Fun√ß√£o para testar inser√ß√£o no banco
        window.testDatabaseInsert = async function() {
            console.log('üß™ === TESTE DE INSER√á√ÉO NO BANCO ===');
            
            if (!currentUser) {
                console.error('‚ùå Usu√°rio n√£o logado');
                return;
            }
            
            const selectedUnit = getSelectedUnit();
            if (!selectedUnit) {
                console.error('‚ùå Nenhuma unidade selecionada');
                return;
            }
            
            const testRecord = {
                data: '2025-01-15',
                horario: '10:00',
                valor: 100.50,
                servico: 'Teste de servi√ßo',
                cliente: 'Cliente Teste',
                profissional: 'Profissional Teste',
                user_id: currentUser.id,
                unit_id: selectedUnit.id,
                status: 'TESTE'
            };
            
            console.log('üì§ Tentando inserir registro de teste:', testRecord);
            
            try {
                const { data, error } = await supabase
                    .from('resultados')
                    .insert([testRecord]);
                
                if (error) {
                    console.error('‚ùå Erro na inser√ß√£o:', error);
                    console.error('üí° Poss√≠veis causas:');
                    console.error('  - RLS (Row Level Security) bloqueando');
                    console.error('  - Pol√≠ticas de seguran√ßa restritivas'); 
                    console.error('  - Campos obrigat√≥rios faltando');
                    console.error('  - Triggers rejeitando dados');
                } else {
                    console.log('‚úÖ Registro de teste inserido com sucesso:', data);
                    
                    // Deletar o registro de teste
                    await supabase
                        .from('resultados')
                        .delete()
                        .eq('status', 'TESTE')
                        .eq('user_id', currentUser.id);
                    
                    console.log('üóëÔ∏è Registro de teste removido');
                }
                
            } catch (err) {
                console.error('‚ùå Erro inesperado:', err);
            }
        };

        function initializeClientes() {
            console.log('üë• M√≥dulo Clientes inicializado');
            // Inicializar tabelas, filtros, etc.
        }

        function initializeAgenda() {
            console.log('üìÖ M√≥dulo Agenda inicializado');
            // Inicializar calend√°rio, eventos, etc.
        }

        function initializeUnidade() {
            console.log('üè¢ M√≥dulo Unidade inicializado');
            // Inicializar gest√£o de unidades
        }

        function initializePosVenda() {
            console.log('üí∞ M√≥dulo P√≥s-Venda inicializado');
            // Inicializar relat√≥rios e an√°lises
        }

        function initializeRecrutamento() {
            console.log('üéØ M√≥dulo Recrutamento inicializado');
            // Inicializar processo seletivo
        }

        // === SISTEMA DE AUTENTICA√á√ÉO ===
        
        // üß™ FUN√á√ÉO DE TESTE - Criar usu√°rio padr√£o se n√£o existir
        async function createDefaultUserIfNeeded() {
            try {
                console.log('üîç Verificando se existem usu√°rios no sistema...');
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id')
                    .limit(1);

                if (error) {
                    console.error('‚ùå Erro ao verificar usu√°rios:', error);
                    return;
                }

                if (!users || users.length === 0) {
                    console.log('‚ö†Ô∏è Nenhum usu√°rio encontrado. Criando usu√°rio padr√£o...');
                    
                    // Criar usu√°rio padr√£o
                    const defaultPassword = 'admin123';
                    const hashedPassword = await hashPassword(defaultPassword);
                    
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert({
                            email: 'admin@dromeflow.com',
                            password: hashedPassword,
                            role_id: 1 // Super admin
                        })
                        .select()
                        .single();

                    if (createError) {
                        console.error('‚ùå Erro ao criar usu√°rio padr√£o:', createError);
                    } else {
                        console.log('‚úÖ Usu√°rio padr√£o criado com sucesso!');
                        console.log('üìß Email: admin@dromeflow.com');
                        console.log('üîê Senha: admin123');
                    }
                } else {
                    console.log('‚úÖ Usu√°rios existentes encontrados no sistema');
                }
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o de usu√°rios:', error);
            }
        }
        
        // Fun√ß√£o para fazer hash da senha (simula√ß√£o simples - em produ√ß√£o use bcrypt)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Fun√ß√£o para carregar informa√ß√µes completas do usu√°rio
        async function loadUserData(userId) {
            try {
                console.log('üë§ Carregando dados completos do usu√°rio:', userId);
                
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select(`
                        id,
                        email,
                        role_id,
                        roles (
                            name,
                            display_name,
                            level
                        )
                    `)
                    .eq('id', userId)
                    .single();

                if (userError) {
                    console.error('‚ùå Erro ao carregar dados do usu√°rio:', userError);
                    throw userError;
                }

                console.log('üìä Dados do usu√°rio carregados:', userData);

                currentUser = {
                    id: userData.id,
                    email: userData.email,
                    role_id: userData.role_id
                };

                userRole = userData.roles;
                console.log('üé≠ Papel do usu√°rio definido:', userRole);

                // Carregar unidades
                console.log('üè¢ Carregando unidades do usu√°rio...');
                await loadUserUnits(userId);
                
                // Carregar m√≥dulos baseado no papel
                console.log('üîê Carregando m√≥dulos baseado no papel...');
                await loadUserModules(userId);

                console.log('‚úÖ Dados do usu√°rio carregados com sucesso');
                return { success: true, user: currentUser };
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
                throw error;
            }
        }

        // Fun√ß√£o para carregar m√≥dulos baseado no papel do usu√°rio
        async function loadUserModules(userId) {
            try {
                console.log('üîê Carregando m√≥dulos para:', userRole?.name);

                // Verificar se userRole foi carregado
                if (!userRole || !userRole.name) {
                    console.error('‚ùå Papel do usu√°rio n√£o foi carregado corretamente');
                    throw new Error('Papel do usu√°rio n√£o definido');
                }

                if (userRole.name === 'super_admin') {
                    // Super Admin v√™ todos os m√≥dulos + interface de gest√£o
                    console.log('üîÑ Chamando loadAllModulesForSuperAdmin()...');
                    await loadAllModulesForSuperAdmin();
                    console.log('‚úÖ loadAllModulesForSuperAdmin() conclu√≠da. M√≥dulos:', availableModules?.length);
                } else if (userRole.name === 'admin') {
                    // Admin da unidade v√™ m√≥dulos da unidade + interface de gest√£o de usu√°rios
                    await loadModulesForUnitAdmin(userId);
                } else {
                    // User comum v√™ apenas m√≥dulos liberados pelo admin
                    await loadModulesForUser(userId);
                }

                // Atualizar sidebar
                updateSidebarForUser();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar m√≥dulos:', error);
                availableModules = [];
                throw error;
            }
        }

        // Carregar todos os m√≥dulos para Super Admin
        async function loadAllModulesForSuperAdmin() {
            try {
                console.log('üîÑ Carregando m√≥dulos para Super Admin...');
                
                const { data: modules, error } = await supabase
                    .from('modules')
                    .select('*')
                    .eq('is_active', true)
                    .order('order_index', { ascending: true });

                if (error) {
                    console.error('‚ùå Erro ao buscar m√≥dulos:', error);
                    throw error;
                }

                console.log('üìä M√≥dulos carregados do banco:', modules);

                // Mapear m√≥dulos com permiss√µes completas para Super Admin
                availableModules = (modules || []).map(module => ({
                    ...module,
                    permissions: { can_view: true, can_edit: true, can_delete: true }
                }));

                console.log('üëë Super Admin - M√≥dulos dispon√≠veis:', availableModules.map(m => `${m.name} (${m.display_name})`));
                
            } catch (error) {
                console.error('Erro ao carregar m√≥dulos para Super Admin:', error);
                throw error;
            }
        }

        // Carregar m√≥dulos para Admin da Unidade
        async function loadModulesForUnitAdmin(userId) {
            try {
                // Verificar se userUnits foi carregado
                if (!userUnits || userUnits.length === 0) {
                    console.warn('‚ö†Ô∏è Admin sem unidades definidas');
                    availableModules = [];
                    return;
                }

                // Para cada unidade que o admin gerencia, buscar m√≥dulos dispon√≠veis
                const modulePromises = userUnits.map(async (unit) => {
                    const { data: unitModules, error } = await supabase
                        .from('unit_modules')
                        .select(`
                            modules (
                                id,
                                name,
                                display_name,
                                icon,
                                permissions
                            )
                        `)
                        .eq('unit_id', unit.id);

                    if (error) {
                        console.error(`Erro ao carregar m√≥dulos para unidade ${unit.name}:`, error);
                        return [];
                    }

                    return (unitModules?.map(um => um.modules) || []);
                });

                const allUnitModules = await Promise.all(modulePromises);
                const flatModules = allUnitModules.flat();
                
                // Remover duplicatas baseado no ID
                const uniqueModules = flatModules.filter((module, index, arr) => 
                    arr.findIndex(m => m.id === module.id) === index
                );

                availableModules = uniqueModules;
                console.log('üè¢ Admin - M√≥dulos carregados:', availableModules.length);
                
            } catch (error) {
                console.error('Erro ao carregar m√≥dulos para Unit Admin:', error);
                availableModules = [];
                throw error;
            }
        }

        // Carregar m√≥dulos para User comum
        async function loadModulesForUser(userId) {
            try {
                // Buscar m√≥dulos que o usu√°rio tem acesso via user_modules
                const { data: userModules, error } = await supabase
                    .from('user_modules')
                    .select(`
                        modules (
                            id,
                            name,
                            display_name,
                            icon,
                            permissions
                        )
                    `)
                    .eq('user_id', userId);

                if (error) {
                    console.error('Erro ao carregar m√≥dulos para usu√°rio:', error);
                    throw error;
                }

                availableModules = userModules?.map(um => um.modules) || [];
                console.log('üë§ User - M√≥dulos carregados:', availableModules.length);
                
            } catch (error) {
                console.error('Erro ao carregar m√≥dulos para User:', error);
                availableModules = [];
                throw error;
            }
        }

        // Carregar m√≥dulos para Admin da Unidade
        async function loadModulesForUnitAdmin(userId) {
            try {
                // Verificar se userUnits foi carregado
                if (!userUnits || userUnits.length === 0) {
                    console.warn('‚ö†Ô∏è Admin n√£o possui unidades associadas');
                    availableModules = [];
                    return;
                }

                // Para cada unidade que o admin gerencia, buscar m√≥dulos dispon√≠veis
                const modulePromises = userUnits.map(async (unit) => {
                    const { data: unitModulesData, error } = await supabase
                        .from('unit_modules')
                        .select(`
                            module_id,
                            modules (
                                id,
                                name,
                                display_name,
                                icon,
                                parent_module,
                                order_index
                            )
                        `)
                        .eq('unit_id', unit.id);

                    if (error) throw error;

                    return unitModulesData?.map(item => ({
                        ...item.modules,
                        unit_id: unit.id,
                        unit_name: unit.name,
                        permissions: { can_view: true, can_create: true, can_edit: true, can_delete: false }
                    })) || [];
                });

                const allUnitModules = await Promise.all(modulePromises);
                const flatModules = allUnitModules.flat();

                // Remover duplicatas
                const uniqueModules = flatModules.filter((module, index, self) => 
                    index === self.findIndex(m => m.name === module.name)
                );

                availableModules = uniqueModules;

                // Armazenar m√≥dulos da unidade para interface de gest√£o
                unitModules = flatModules;

                console.log('üè¢ Admin da Unidade - M√≥dulos carregados:', availableModules.length);
                
            } catch (error) {
                console.error('Erro ao carregar m√≥dulos para Admin:', error);
                throw error;
            }
        }

        // Carregar m√≥dulos para User comum
        async function loadModulesForUser(userId) {
            try {
                // Verificar se userUnits foi carregado
                if (!userUnits || userUnits.length === 0) {
                    console.warn('‚ö†Ô∏è Usu√°rio n√£o possui unidades associadas');
                    availableModules = [];
                    return;
                }

                const modulePromises = userUnits.map(async (unit) => {
                    const { data: userModulesData, error } = await supabase
                        .from('user_module_permissions')
                        .select(`
                            module_id,
                            modules (
                                id,
                                name,
                                display_name,
                                icon,
                                parent_module,
                                order_index
                            )
                        `)
                        .eq('user_id', userId)
                        .eq('unit_id', unit.id);

                    if (error) throw error;

                    return userModulesData?.map(item => ({
                        ...item.modules,
                        unit_id: unit.id,
                        unit_name: unit.name,
                        permissions: { can_view: true, can_create: false, can_edit: false, can_delete: false }
                    })) || [];
                });

                const allUserModules = await Promise.all(modulePromises);
                const flatUserModules = allUserModules.flat();

                // Remover duplicatas
                const uniqueUserModules = flatUserModules.filter((module, index, self) => 
                    index === self.findIndex(m => m.name === module.name)
                );

                availableModules = uniqueUserModules;

                console.log('üë§ User - M√≥dulos carregados:', availableModules.length);
                
            } catch (error) {
                console.error('Erro ao carregar m√≥dulos para User:', error);
                throw error;
            }
        }

        // Fun√ß√£o auxiliar para fechar modal de login
        function closeLoginModal() {
            console.log('üîí Fechando modal de login...');
            const loginOverlay = document.getElementById('loginOverlay');
            const body = document.body;
            
            if (loginOverlay) {
                loginOverlay.style.display = 'none';
                loginOverlay.classList.add('hidden');
                body.classList.remove('login-active'); // Remove classe do body
                console.log('‚úÖ Modal de login fechado com sucesso');
            } else {
                console.error('‚ùå Elemento loginOverlay n√£o encontrado');
            }
        }

        // Fun√ß√£o auxiliar para abrir modal de login
        function openLoginModal() {
            console.log('üîì Abrindo modal de login...');
            const loginOverlay = document.getElementById('loginOverlay');
            const body = document.body;
            
            if (loginOverlay) {
                loginOverlay.style.display = 'flex';
                loginOverlay.classList.remove('hidden');
                body.classList.add('login-active'); // Adiciona classe ao body
                console.log('‚úÖ Modal de login aberto com sucesso');
            } else {
                console.error('‚ùå Elemento loginOverlay n√£o encontrado');
            }
        }

        // Fun√ß√£o para verificar autentica√ß√£o
        async function checkAuth() {
            console.log('üîê Verificando autentica√ß√£o...');
            const savedUser = localStorage.getItem('dromeflow_user');
            
            console.log('üíæ Usu√°rio salvo no localStorage:', !!savedUser);
            
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    console.log('üë§ Dados do usu√°rio encontrados:', userData.email);
                    
                    // Carregar dados completos do usu√°rio
                    console.log('üîÑ Carregando dados completos...');
                    await loadUserData(userData.id);
                    
                    console.log('‚úÖ Dados carregados, fechando modal de login');
                    closeLoginModal();
                    updateUserInterface();
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados salvos:', error);
                    localStorage.removeItem('dromeflow_user');
                }
            }
            
            console.log('üîì Nenhum usu√°rio autenticado, exibindo modal de login');
            openLoginModal();
            return false;
        }

        // Fun√ß√£o para verificar se usu√°rio tem permiss√£o espec√≠fica
        function hasPermission(moduleName, permission = 'can_view') {
            const module = availableModules.find(m => m.name === moduleName);
            return module && module.permissions[permission];
        }

        // Fun√ß√£o para verificar se usu√°rio pode acessar um m√≥dulo
        function canAccessModule(moduleName) {
            return hasPermission(moduleName, 'can_view');
        }

        // Fun√ß√£o para realizar login
        async function performLogin(email, password) {
            try {
                console.log('üîê Iniciando processo de login para:', email);
                
                // Buscar usu√°rio na base de dados
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, email, password, role_id')
                    .eq('email', email)
                    .limit(1);

                if (error) {
                    console.error('‚ùå Erro na consulta do usu√°rio:', error);
                    throw new Error('Erro ao consultar base de dados: ' + error.message);
                }

                if (!users || users.length === 0) {
                    console.error('‚ùå Usu√°rio n√£o encontrado:', email);
                    throw new Error('E-mail n√£o encontrado');
                }

                const user = users[0];
                console.log('üë§ Usu√°rio encontrado:', { id: user.id, email: user.email, role_id: user.role_id });
                
                // Verificar senha - primeiro tenta senha direta, depois hash
                let senhaValida = false;
                
                if (user.password === password) {
                    senhaValida = true;
                    console.log('‚úÖ Login com senha em texto simples');
                } else {
                    const hashedPassword = await hashPassword(password);
                    if (user.password === hashedPassword) {
                        senhaValida = true;
                        console.log('‚úÖ Login com senha hashada');
                    }
                }
                
                if (!senhaValida) {
                    console.error('‚ùå Senha incorreta para:', email);
                    throw new Error('Senha incorreta');
                }

                console.log('üîÑ Carregando dados completos do usu√°rio...');
                // Login bem-sucedido - carregar dados completos do usu√°rio
                await loadUserData(user.id);

                // Salvar no localStorage
                localStorage.setItem('dromeflow_user', JSON.stringify(currentUser));
                console.log('üíæ Dados do usu√°rio salvos no localStorage');

                return { success: true, user: currentUser };

            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                return { success: false, error: error.message };
            }
        }

        // Fun√ß√£o para carregar unidades do usu√°rio
        async function loadUserUnits(userId) {
            try {
                console.log('üîç Carregando unidades para o usu√°rio:', userId);
                
                const { data: userUnitsData, error } = await supabase
                    .from('user_units')
                    .select(`
                        unit_id,
                        units (
                            id,
                            name
                        )
                    `)
                    .eq('user_id', userId);

                if (error) {
                    console.error('Erro na consulta user_units:', error);
                    throw new Error('Erro ao carregar unidades: ' + error.message);
                }

                console.log('üìä Dados retornados da consulta:', userUnitsData);

                // Mapear as unidades corretamente
                userUnits = userUnitsData?.map(item => ({
                    id: item.units.id,
                    name: item.units.name
                })) || [];
                
                console.log('‚úÖ Unidades processadas:', userUnits);
                
                // Preencher select do header
                populateUnitSelect();
                
                return userUnits;
            } catch (error) {
                console.error('‚ùå Erro ao carregar unidades:', error);
                userUnits = [];
                populateUnitSelect(); // Garante que o select seja limpo em caso de erro
                throw error;
            }
        }

        // Fun√ß√£o para preencher o select de unidades no header
        function populateUnitSelect() {
            const unitSelect = document.getElementById('unitSelect');
            if (!unitSelect) return;

            console.log('üè¢ Preenchendo select de unidades com:', userUnits);

            // Limpar op√ß√µes existentes
            unitSelect.innerHTML = '<option value="">Selecione uma unidade</option>';
            
            // Verificar se h√° unidades dispon√≠veis
            if (!userUnits || userUnits.length === 0) {
                console.log('‚ö†Ô∏è Nenhuma unidade encontrada para o usu√°rio');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhuma unidade dispon√≠vel';
                option.disabled = true;
                unitSelect.appendChild(option);
                return;
            }
            
            // Adicionar cada unidade ao select
            userUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = unit.name;
                unitSelect.appendChild(option);
                console.log(`‚ûï Unidade adicionada: ${unit.name} (${unit.id})`);
            });

            // Se h√° apenas uma unidade, selecion√°-la automaticamente
            if (userUnits.length === 1) {
                unitSelect.value = userUnits[0].id;
                console.log('üéØ Unidade √∫nica selecionada automaticamente:', userUnits[0].name);
                
                // Salvar no localStorage
                localStorage.setItem('lastSelectedUnit', userUnits[0].id);
                
                // Disparar evento de mudan√ßa para que outros componentes possam reagir
                const changeEvent = new Event('change', { bubbles: true });
                unitSelect.dispatchEvent(changeEvent);
            } else if (userUnits.length > 1) {
                // Se h√° m√∫ltiplas unidades, tentar restaurar a √∫ltima selecionada
                const lastSelectedUnit = localStorage.getItem('lastSelectedUnit');
                if (lastSelectedUnit && userUnits.find(u => u.id === lastSelectedUnit)) {
                    unitSelect.value = lastSelectedUnit;
                    const unitName = userUnits.find(u => u.id === lastSelectedUnit)?.name;
                    console.log('üîÑ √öltima unidade selecionada restaurada:', unitName);
                    
                    // Disparar evento de mudan√ßa
                    const changeEvent = new Event('change', { bubbles: true });
                    unitSelect.dispatchEvent(changeEvent);
                } else {
                    console.log('üìã M√∫ltiplas unidades dispon√≠veis - aguardando sele√ß√£o do usu√°rio');
                }
            }

            console.log('‚úÖ Select de unidades populado com sucesso');
        }

        // Fun√ß√£o para atualizar interface do usu√°rio
        function updateUserInterface() {
            console.log('üîÑ Atualizando interface do usu√°rio');
            
            // Atualizar informa√ß√µes do usu√°rio na sidebar
            const userAvatar = document.querySelector('.user-avatar');
            const userName = document.querySelector('.user-name');
            const userRoleElement = document.querySelector('.user-role');

            if (currentUser && userAvatar && userName && userRoleElement) {
                userAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
                userName.textContent = currentUser.email.split('@')[0];
                
                // Mostrar papel do usu√°rio e unidades
                if (userRole) {
                    const unitCount = userUnits.length;
                    let roleText = userRole.display_name;
                    
                    if (unitCount > 0) {
                        roleText += ` - ${unitCount} unidade${unitCount > 1 ? 's' : ''}`;
                    }
                    
                    userRoleElement.textContent = roleText;
                } else {
                    userRoleElement.textContent = 'Papel n√£o definido';
                }
                
                console.log('üë§ Interface do usu√°rio atualizada:', {
                    email: currentUser.email,
                    role: userRole?.name,
                    unitCount: userUnits.length,
                    units: userUnits.map(u => u.name)
                });
            }

            // Atualizar sidebar baseado nas permiss√µes
            updateSidebarForUser();
            
            // ‚úÖ CORRE√á√ÉO: Popular dropdown de unidades
            populateUnitSelect();
        }

        // Fun√ß√£o para atualizar a sidebar baseada nas permiss√µes do usu√°rio
        function updateSidebarForUser() {
            console.log('üîß Atualizando sidebar baseada nas permiss√µes');
            console.log('üìä M√≥dulos dispon√≠veis:', availableModules?.length || 0);
            console.log('üë§ User Role:', userRole?.name);
            
            const sidebarNav = document.querySelector('.sidebar-nav');
            if (!sidebarNav) return;

            // Limpar navega√ß√£o atual
            sidebarNav.innerHTML = '';

            // Se n√£o h√° m√≥dulos dispon√≠veis, mostrar mensagem
            if (!availableModules || availableModules.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum m√≥dulo dispon√≠vel para exibir');
                sidebarNav.innerHTML = `
                    <div class="nav-item empty-state-nav">
                        <i class="fas fa-info-circle empty-state-icon"></i>
                        <p class="empty-state-text">Nenhum m√≥dulo ativo dispon√≠vel</p>
                        <small>Ative m√≥dulos no banco de dados</small>
                    </div>
                `;
                return;
            }

            // Separar m√≥dulos principais e subm√≥dulos
            const mainModules = availableModules.filter(module => !module.parent_module);
            const subModules = availableModules.filter(module => module.parent_module);

            // Criar navega√ß√£o dinamicamente
            mainModules.forEach(module => {
                const navItem = createNavItem(module, subModules);
                if (navItem) {
                    sidebarNav.appendChild(navItem);
                }
            });

            // Configurar event listeners para os novos menus
            setupDynamicMenuListeners();

            // Direcionar para m√≥dulo inicial baseado no role do usu√°rio
            let initialModule = 'dashboard'; // Padr√£o para todos
            
            // Super Admin sempre vai para gest√£o-sistema
            if (userRole?.name === 'super_admin') {
                const gestaoModule = availableModules.find(m => m.name === 'gestao-sistema');
                if (gestaoModule) {
                    initialModule = 'gestao-sistema';
                    console.log('üî• Super Admin detectado - direcionando para Gest√£o do Sistema');
                } else {
                    console.warn('‚ö†Ô∏è M√≥dulo gestao-sistema n√£o encontrado para Super Admin');
                }
            } else {
                console.log('üë§ Usu√°rio regular - direcionando para Dashboard');
            }
            
            // Carregar m√≥dulo inicial se dispon√≠vel
            const targetModule = availableModules.find(m => m.name === initialModule);
            if (targetModule) {
                const targetLink = document.querySelector(`[data-module="${initialModule}"]`);
                if (targetLink) {
                    targetLink.classList.add('active');
                    loadModuleContent(initialModule);
                    console.log(`‚úÖ M√≥dulo inicial carregado: ${initialModule}`);
                } else {
                    console.warn(`‚ö†Ô∏è Link n√£o encontrado para m√≥dulo: ${initialModule}`);
                }
            } else {
                console.warn(`‚ö†Ô∏è M√≥dulo inicial n√£o dispon√≠vel: ${initialModule}`);
                // Fallback para o primeiro m√≥dulo dispon√≠vel
                if (availableModules.length > 0) {
                    const firstModule = availableModules[0];
                    const firstLink = document.querySelector(`[data-module="${firstModule.name}"]`);
                    if (firstLink) {
                        firstLink.classList.add('active');
                        loadModuleContent(firstModule.name);
                        console.log(`‚úÖ Carregado primeiro m√≥dulo dispon√≠vel: ${firstModule.name}`);
                    }
                }
            }

            console.log('‚úÖ Sidebar atualizada com', mainModules.length, 'm√≥dulos principais');
        }

        // Fun√ß√£o de debug para Super Admin
        window.debugSuperAdminModules = function() {
            console.log('=== DEBUG SUPER ADMIN MODULES ===');
            console.log('Current User:', currentUser);
            console.log('User Role:', userRole);
            console.log('Available Modules:', availableModules);
            console.log('Total Modules:', availableModules?.length || 0);
            console.log('Modules from Database Only:', availableModules?.map(m => `${m.name} (${m.display_name})`));
            console.log('Sidebar Nav HTML:', document.querySelector('.sidebar-nav')?.innerHTML);
            console.log('================================');
        };

        // Fun√ß√£o para for√ßar recarregamento dos m√≥dulos do Super Admin
        window.forceReloadSuperAdminModules = async function() {
            if (userRole?.name === 'super_admin') {
                console.log('üîÑ For√ßando recarregamento dos m√≥dulos do Super Admin...');
                await loadAllModulesForSuperAdmin();
                updateSidebarForUser();
                console.log('‚úÖ M√≥dulos recarregados!');
            } else {
                console.warn('‚ö†Ô∏è Usu√°rio n√£o √© Super Admin');
            }
        };

        // Fun√ß√£o para criar item de navega√ß√£o
        function createNavItem(module, subModules) {
            const navItem = document.createElement('div');
            navItem.className = 'nav-item';

            // Verificar se h√° subm√≥dulos para este m√≥dulo
            const moduleSubModules = subModules.filter(sub => sub.parent_module === module.id);
            const hasSubModules = moduleSubModules.length > 0;

            // Special handling for dashboard module
            if (module.name === 'dashboard') {
                navItem.innerHTML = `
                    <a href="#" class="nav-link" data-menu="dashboard">
                        <i class="nav-icon ${module.icon}"></i>
                        <span class="nav-text">${module.display_name}</span>
                        <i class="nav-arrow fas fa-chevron-right"></i>
                    </a>
                    <div class="submenu" id="submenu-dashboard">
                        <div class="submenu-item">
                            <a href="#" class="submenu-link" data-submenu="geral">
                                <i class="fas fa-chart-line"></i>
                                <span>Geral</span>
                            </a>
                        </div>
                        <div class="submenu-item">
                            <a href="#" class="submenu-link" data-submenu="clientes">
                                <i class="fas fa-users"></i>
                                <span>Clientes</span>
                            </a>
                        </div>
                    </div>
                `;
            } else if (module.name === 'gestao-sistema') {
                // Special handling for gestao-sistema module
                navItem.innerHTML = `
                    <a href="#" class="nav-link" data-menu="gestao-sistema">
                        <i class="nav-icon ${module.icon}"></i>
                        <span class="nav-text">${module.display_name}</span>
                        <i class="nav-arrow fas fa-chevron-right"></i>
                    </a>
                    <div class="submenu" id="submenu-gestao-sistema">
                        <div class="submenu-item">
                            <a href="#" class="submenu-link" data-submenu="unidades">
                                <i class="fas fa-building"></i>
                                <span>Unidades</span>
                            </a>
                        </div>
                        <div class="submenu-item">
                            <a href="#" class="submenu-link" data-submenu="administradores">
                                <i class="fas fa-user-shield"></i>
                                <span>Administradores</span>
                            </a>
                        </div>
                    </div>
                `;
            } else if (hasSubModules) {
                // Criar menu com subm√≥dulos
                navItem.innerHTML = `
                    <a href="#" class="nav-link" data-menu="${module.name}">
                        <i class="nav-icon ${module.icon}"></i>
                        <span class="nav-text">${module.display_name}</span>
                        <i class="nav-arrow fas fa-chevron-right"></i>
                    </a>
                    <div class="submenu" id="submenu-${module.name}">
                        ${moduleSubModules.map(subModule => `
                            <div class="submenu-item">
                                <a href="#" class="submenu-link" data-module="${subModule.name}" 
                                   data-permissions='${JSON.stringify(subModule.permissions)}'>
                                    <span>${subModule.display_name}</span>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Criar link direto
                navItem.innerHTML = `
                    <a href="#" class="nav-link" data-module="${module.name}" 
                       data-permissions='${JSON.stringify(module.permissions)}'>
                        <i class="nav-icon ${module.icon}"></i>
                        <span class="nav-text">${module.display_name}</span>
                    </a>
                `;
            }

            console.log(`üìù Item de navega√ß√£o criado: ${module.display_name}`);
            return navItem;
        }

        // Fun√ß√£o para configurar event listeners dos menus dinamicamente
        function setupDynamicMenuListeners() {
            // Remover listeners antigos se existirem
            document.querySelectorAll('.nav-link[data-menu], .nav-link[data-module], .submenu-link[data-module], .submenu-link[data-submenu]').forEach(element => {
                element.replaceWith(element.cloneNode(true));
            });

            // Configurar listeners para menus principais
            document.querySelectorAll('.nav-link[data-menu]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const menuId = link.dataset.menu;
                    const submenu = document.getElementById(`submenu-${menuId}`);
                    
                    if (submenu) {
                        const isExpanded = link.classList.contains('expanded');
                        
                        // Fechar todos os outros submenus
                        document.querySelectorAll('.nav-link').forEach(l => {
                            l.classList.remove('expanded', 'active');
                        });
                        document.querySelectorAll('.submenu').forEach(s => {
                            s.classList.remove('expanded');
                        });
                        
                        // Toggle do submenu atual
                        if (!isExpanded) {
                            link.classList.add('expanded', 'active'); // üîß Adicionar 'active' tamb√©m
                            submenu.classList.add('expanded');
                            
                            // Para dashboard, carregar m√≥dulo e submenu padr√£o
                            if (menuId === 'dashboard') {
                                loadModuleContent('dashboard').then(() => {
                                    // Ativar submenu padr√£o (Geral) ap√≥s carregamento
                                    setTimeout(() => {
                                        loadDashboardSubmenu('geral');
                                        const geralLink = document.querySelector('[data-submenu="geral"]');
                                        if (geralLink) {
                                            geralLink.classList.add('active');
                                        }
                                    }, 100);
                                }).catch(error => {
                                    console.error('‚ùå Erro ao carregar dashboard:', error);
                                });
                            } else if (menuId === 'gestao-sistema') {
                                loadModuleContent('gestao-sistema').then(() => {
                                    // Ativar submenu padr√£o (Unidades) ap√≥s carregamento
                                    setTimeout(() => {
                                        loadGestaoSistemaSubmenu('unidades');
                                        const unidadesLink = document.querySelector('[data-submenu="unidades"]');
                                        if (unidadesLink) {
                                            unidadesLink.classList.add('active');
                                        }
                                    }, 100);
                                }).catch(error => {
                                    console.error('‚ùå Erro ao carregar gest√£o do sistema:', error);
                                });
                            }
                        }
                    }
                });
            });

            // Configurar listeners para submenus do dashboard e gest√£o do sistema
            document.querySelectorAll('[data-submenu]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const submenu = link.dataset.submenu;
                    
                    console.log('üéØ Submenu clicado:', submenu);
                    
                    // Remover active de todos os submenus
                    document.querySelectorAll('[data-submenu]').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    // Adicionar active ao submenu clicado
                    link.classList.add('active');
                    
                    // üîß CORRE√á√ÉO: Identificar o m√≥dulo pai pelo container do submenu
                    const submenuContainer = link.closest('.submenu');
                    let activeMenu = null;
                    
                    if (submenuContainer) {
                        if (submenuContainer.id === 'submenu-dashboard') {
                            activeMenu = 'dashboard';
                        } else if (submenuContainer.id === 'submenu-gestao-sistema') {
                            activeMenu = 'gestao-sistema';
                        }
                    }
                    
                    console.log('üîç M√≥dulo identificado:', activeMenu, 'para submenu:', submenu);
                    
                    // Carregar submenu baseado no m√≥dulo identificado
                    if (activeMenu === 'dashboard') {
                        // Verificar se m√≥dulo dashboard est√° carregado
                        if (!document.querySelector('#dashboard-geral, #dashboard-clientes')) {
                            console.log('üì¶ Carregando m√≥dulo dashboard...');
                            loadModuleContent('dashboard').then(() => {
                                setTimeout(() => loadDashboardSubmenu(submenu), 200);
                            });
                        } else {
                            loadDashboardSubmenu(submenu);
                        }
                    } else if (activeMenu === 'gestao-sistema') {
                        // Verificar se m√≥dulo gestao-sistema est√° carregado
                        if (!document.querySelector('#gestao-unidades, #gestao-administradores')) {
                            console.log('üì¶ Carregando m√≥dulo gest√£o do sistema...');
                            loadModuleContent('gestao-sistema').then(() => {
                                setTimeout(() => loadGestaoSistemaSubmenu(submenu), 200);
                            });
                        } else {
                            loadGestaoSistemaSubmenu(submenu);
                        }
                    } else {
                        console.error('‚ùå N√£o foi poss√≠vel identificar o m√≥dulo pai para o submenu:', submenu);
                    }
                });
            });

            // Configurar listeners para m√≥dulos
            document.querySelectorAll('[data-module]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const module = link.dataset.module;
                    
                    // Remover active de todos os links
                    document.querySelectorAll('.nav-link, .submenu-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    // Adicionar active ao link clicado
                    link.classList.add('active');
                    
                    // Atualizar t√≠tulo da p√°gina
                    const moduleData = availableModules.find(m => m.name === module);
                    const pageTitle = document.getElementById('pageTitle');
                    if (pageTitle && moduleData) {
                        pageTitle.textContent = moduleData.display_name;
                    }
                    
                    // Carregar conte√∫do do m√≥dulo
                    loadModuleContent(module);
                });
            });
        }

        // Fun√ß√£o para atualizar menus baseado no usu√°rio
        function updateMenusForUser() {
            console.log('üìã Atualizando menus para usu√°rio:', currentUser?.email);
            console.log('üè¢ Unidades dispon√≠veis:', userUnits?.map(u => u.name));
            
            // Aqui voc√™ pode implementar l√≥gica para:
            // - Mostrar/ocultar menus espec√≠ficos baseado nas unidades
            // - Configurar permiss√µes por unidade
            // - Personalizar a experi√™ncia do usu√°rio
            
            // Exemplo: Se o usu√°rio n√£o tem unidades, desabilitar alguns menus
            const hasUnits = userUnits && userUnits.length > 0;
            
            // Habilitar/desabilitar menus que dependem de unidade
            const unitDependentMenus = document.querySelectorAll('[data-requires-unit="true"]');
            unitDependentMenus.forEach(menu => {
                if (hasUnits) {
                    menu.style.opacity = '1';
                    menu.style.pointerEvents = 'auto';
                } else {
                    menu.style.opacity = '0.5';
                    menu.style.pointerEvents = 'none';
                }
            });
            
            console.log('‚úÖ Menus atualizados baseado no acesso do usu√°rio');
        }

        // Event listeners do formul√°rio de login
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ DOM carregado, configurando sistema de login...');
            
            const loginForm = document.getElementById('loginForm');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const loginBtn = document.getElementById('loginBtn');
            const loginOverlay = document.getElementById('loginOverlay');

            // Verificar se elementos existem
            console.log('üîç Verificando elementos do DOM:');
            console.log('- loginForm:', !!loginForm);
            console.log('- errorMessage:', !!errorMessage);
            console.log('- successMessage:', !!successMessage);
            console.log('- loginBtn:', !!loginBtn);
            console.log('- loginOverlay:', !!loginOverlay);

            if (!loginForm) {
                console.error('‚ùå Formul√°rio de login n√£o encontrado!');
                return;
            }

            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('üìù Formul√°rio de login submetido');
                
                // Limpar mensagens
                if (errorMessage) errorMessage.style.display = 'none';
                if (successMessage) successMessage.style.display = 'none';
                
                // Obter dados do formul√°rio
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;

                console.log('üìß Email:', email);
                console.log('üîê Senha fornecida:', password ? 'Sim' : 'N√£o');

                if (!email || !password) {
                    console.warn('‚ö†Ô∏è Campos obrigat√≥rios n√£o preenchidos');
                    if (errorMessage) {
                        errorMessage.textContent = 'Por favor, preencha todos os campos';
                        errorMessage.style.display = 'block';
                    }
                    return;
                }

                // Mostrar loading
                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<span class="loading-spinner"></span>Entrando...';
                }

                try {
                    console.log('üîÑ Iniciando processo de login...');
                    const result = await performLogin(email, password);
                    
                    console.log('üìä Resultado do login:', result);
                    
                    if (result.success) {
                        console.log('‚úÖ Login bem-sucedido!');
                        if (successMessage) {
                            successMessage.textContent = 'Login realizado com sucesso!';
                            successMessage.style.display = 'block';
                        }
                        
                        // ‚úÖ CORRIGIR: Fechar modal usando fun√ß√£o auxiliar
                        closeLoginModal();
                        
                        // Atualizar interface do usu√°rio
                        console.log('üîÑ Atualizando interface...');
                        updateUserInterface();
                        
                        // Limpar formul√°rio
                        if (loginForm) {
                            loginForm.reset();
                        }
                        
                        // Carregar dashboard como m√≥dulo padr√£o
                        setTimeout(() => {
                            if (availableModules?.some(m => m.name === 'dashboard')) {
                                console.log('üìä Carregando dashboard como m√≥dulo padr√£o...');
                                loadModuleContent('dashboard');
                            } else {
                                console.log('‚ö†Ô∏è Dashboard n√£o dispon√≠vel nos m√≥dulos:', availableModules?.map(m => m.name));
                            }
                        }, 300);
                        
                    } else {
                        console.error('‚ùå Falha no login:', result.error);
                        if (errorMessage) {
                            errorMessage.textContent = result.error || 'Erro ao realizar login';
                            errorMessage.style.display = 'block';
                        }
                    }
                    
                } catch (error) {
                    console.error('üí• Erro inesperado no login:', error);
                    if (errorMessage) {
                        errorMessage.textContent = 'Erro inesperado. Tente novamente.';
                        errorMessage.style.display = 'block';
                    }
                } finally {
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = 'Entrar';
                    }
                }
            });

            // Verificar autentica√ß√£o ao carregar a p√°gina
            console.log('üîç Verificando autentica√ß√£o existente...');
            
            // Criar usu√°rio padr√£o se necess√°rio (apenas para desenvolvimento)
            createDefaultUserIfNeeded();
            
            // Verificar autentica√ß√£o e exibir modal se necess√°rio
            checkAuth().then(isAuthenticated => {
                if (!isAuthenticated) {
                    console.log('‚ùó Usu√°rio n√£o autenticado, garantindo que modal esteja vis√≠vel');
                    // Garantir que o modal esteja vis√≠vel
                    setTimeout(() => {
                        const loginOverlay = document.getElementById('loginOverlay');
                        if (loginOverlay && loginOverlay.style.display !== 'flex') {
                            openLoginModal();
                        }
                    }, 100);
                }
            });
        });

        // Gerenciamento de tema
        const themeToggle = document.getElementById('headerThemeToggle');
        const body = document.body;
        
        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            body.classList.toggle('dark', savedTheme === 'dark');
            updateThemeIcon();
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            const theme = body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            updateThemeIcon();
            
            // Notificar m√≥dulos sobre mudan√ßa de tema
            notifyModulesThemeChange();
        });

        // Listener para bot√£o de atualizar - Sistema completo
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
                console.log('üîÑ Iniciando atualiza√ß√£o completa do sistema...');
                
                // Mostrar loading no bot√£o
                const originalIcon = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                refreshBtn.disabled = true;
                
                try {
                    // 1. Atualizar dados do usu√°rio e m√≥dulos
                    if (currentUser) {
                        await loadUserData(currentUser.id);
                        console.log('‚úÖ Dados do usu√°rio atualizados');
                    }
                    
                    // 2. Recarregar m√≥dulo atual se houver
                    const currentModule = document.querySelector('.nav-link.active, .submenu-link.active, [data-module].active')?.dataset.module;
                    if (currentModule) {
                        // Limpar cache do template
                        templateCache.delete(currentModule);
                        
                        // Recarregar o m√≥dulo
                        loadModuleContent(currentModule);
                        console.log(`‚úÖ M√≥dulo "${currentModule}" recarregado`);
                        
                        // Se for dashboard, recarregar dados espec√≠ficos
                        if (currentModule === 'dashboard' && typeof loadDashboardData === 'function') {
                            await loadDashboardData();
                            console.log('‚úÖ Dados do dashboard atualizados');
                        }
                    }
                    
                    // 3. Atualizar interface do usu√°rio
                    updateUserInterface();
                    console.log('‚úÖ Interface atualizada');
                    
                    console.log('üéâ Atualiza√ß√£o completa do sistema conclu√≠da');
                    
                } catch (error) {
                    console.error('‚ùå Erro durante atualiza√ß√£o:', error);
                } finally {
                    // Restaurar bot√£o
                    refreshBtn.innerHTML = originalIcon;
                    refreshBtn.disabled = false;
                }
            });
        }

        function updateThemeIcon() {
            const icon = themeToggle.querySelector('i');
            if (body.classList.contains('dark')) {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        }

        // Fun√ß√£o para notificar m√≥dulos sobre mudan√ßa de tema
        function notifyModulesThemeChange() {
            const isDarkMode = body.classList.contains('dark');
            
            // Atualizar dados do m√≥dulo se dispon√≠vel
            if (window.moduleUserData) {
                window.moduleUserData.isDarkMode = isDarkMode;
            }
            
            // Notificar fun√ß√£o de gest√£o do sistema se existir
            if (typeof window.updateGestaoSistemaTheme === 'function') {
                window.updateGestaoSistemaTheme(isDarkMode);
            }
            
            console.log(`üé® Tema alterado para: ${isDarkMode ? 'dark' : 'light'}`);
        }

        // Gerenciamento da sidebar
        const sidebar = document.getElementById('sidebar');

        // Fun√ß√£o para toggle da sidebar
        function toggleSidebar() {
            // Verificar se est√° em mobile ou desktop
            if (window.innerWidth <= 768) {
                // Mobile: toggle mobile-open class
                sidebar.classList.toggle('mobile-open');
            } else {
                // Desktop: toggle collapsed class
                sidebar.classList.toggle('collapsed');
            }
        }

        // Adicionar evento de clique em √°reas vazias da sidebar
        sidebar.addEventListener('click', (e) => {
            // Verificar se o clique foi em uma √°rea vazia (n√£o em menus, links, bot√µes)
            const target = e.target;
            
            // Elementos que N√ÉO devem ativar o toggle
            const interactiveSelectors = [
                '.nav-link', '.submenu-link', '.user-info',
                '.nav-icon', '.nav-text', '.nav-arrow',
                '.user-avatar', '.user-name', '.user-role',
                'button', 'a', 'input', 'select'
            ];
            
            // Verificar se o clique foi em um elemento interativo ou seus filhos
            let isInteractiveElement = false;
            for (const selector of interactiveSelectors) {
                if (target.matches(selector) || target.closest(selector)) {
                    isInteractiveElement = true;
                    break;
                }
            }
            
            // √Åreas v√°lidas para toggle (clique direto na sidebar-nav ou espa√ßos vazios)
            const isValidToggleArea = (
                target === sidebar ||
                target.matches('.sidebar-nav') ||
                (target.matches('.nav-item') && !target.querySelector('.nav-link:hover'))
            );
            
            // Se n√£o foi em elemento interativo E foi em √°rea v√°lida
            if (!isInteractiveElement && isValidToggleArea) {
                e.preventDefault();
                e.stopPropagation();
                
                // Adicionar feedback visual
                const sidebarNav = sidebar.querySelector('.sidebar-nav');
                sidebarNav.classList.add('click-active');
                setTimeout(() => {
                    sidebarNav.classList.remove('click-active');
                }, 150);
                
                toggleSidebar();
            }
        });

        // Fechar sidebar mobile ao clicar fora
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                const isClickInsideSidebar = sidebar.contains(e.target);
                
                if (!isClickInsideSidebar && sidebar.classList.contains('mobile-open')) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

        // Gerenciar responsividade ao redimensionar janela
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                // Em mobile, remover collapsed e usar mobile-open
                sidebar.classList.remove('collapsed');
                if (sidebar.classList.contains('mobile-open')) {
                    // Manter aberto se j√° estava aberto
                } else {
                    // Fechar se n√£o estava aberto
                    sidebar.classList.remove('mobile-open');
                }
            } else {
                // Em desktop, remover mobile-open e usar collapsed se necess√°rio
                sidebar.classList.remove('mobile-open');
            }
        });

        // Gerenciamento dos menus
        const navLinks = document.querySelectorAll('.nav-link[data-menu]');
        const moduleLinks = document.querySelectorAll('[data-module]');
        const pageTitle = document.getElementById('pageTitle');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const menuId = link.dataset.menu;
                const submenu = document.getElementById(`submenu-${menuId}`);
                
                if (submenu) {
                    const isExpanded = link.classList.contains('expanded');
                    
                    // Fechar todos os outros submenus
                    document.querySelectorAll('.nav-link').forEach(l => {
                        l.classList.remove('expanded');
                    });
                    document.querySelectorAll('.submenu').forEach(s => {
                        s.classList.remove('expanded');
                    });
                    
                    // Toggle do submenu atual
                    if (!isExpanded) {
                        link.classList.add('expanded');
                        submenu.classList.add('expanded');
                    }
                }
            });
        });

        moduleLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const module = link.dataset.module;
                
                // Remover active de todos os links
                document.querySelectorAll('.nav-link, .submenu-link').forEach(l => {
                    l.classList.remove('active');
                });
                
                // Adicionar active ao link clicado
                link.classList.add('active');
                
                // Atualizar t√≠tulo da p√°gina
                const moduleNames = {
                    'dashboard': 'Dashboard',
                    'unidade': 'Gest√£o de Unidades',
                    'clientes': 'Gest√£o de Clientes',
                    'agenda': 'Agenda',
                    'pos-venda': 'P√≥s-Venda',
                    'recrutamento': 'Recrutamento'
                };
                
                pageTitle.textContent = moduleNames[module] || 'Dashboard';
                
                // Limpar submenu se n√£o for dashboard
                clearHeaderSubmenu();
                
                // Aqui voc√™ pode carregar o conte√∫do do m√≥dulo via AJAX
                loadModuleContent(module);
            });
        });

        function loadModuleContent(module) {
            return new Promise((resolve, reject) => {
                // Verificar se usu√°rio tem permiss√£o para acessar o m√≥dulo
                if (!canAccessModule(module)) {
                    console.warn(`‚ö†Ô∏è Usu√°rio n√£o tem permiss√£o para acessar o m√≥dulo: ${module}`);
                    
                    const contentArea = document.getElementById('contentArea');
                    contentArea.innerHTML = `
                        <div class="access-denied-container">
                            <i class="fas fa-lock access-denied-icon"></i>
                            <h2 class="access-denied-title">Acesso Negado</h2>
                            <p class="access-denied-message">
                                Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.
                            </p>
                            <button onclick="loadModuleContent('dashboard')" class="access-denied-button">
                                <i class="fas fa-home"></i> Voltar ao Dashboard
                            </button>
                        </div>
                    `;
                    reject(new Error('Acesso negado'));
                    return;
                }

                const contentArea = document.getElementById('contentArea');
                
                // Verificar se o template j√° est√° em cache
                if (templateCache.has(module)) {
                    console.log(`üì¶ Carregando "${module}" do cache`);
                    contentArea.innerHTML = templateCache.get(module);
                    
                    // Enviar dados para m√≥dulo em cache
                    setTimeout(() => {
                        sendModuleInitData(module);
                    }, 100);
                    
                    // Disparar evento de m√≥dulo carregado
                    const event = new CustomEvent('moduleLoaded', {
                        detail: { 
                            module: module,
                            fromCache: true,
                            timestamp: new Date().toISOString(),
                            permissions: availableModules.find(m => m.name === module)?.permissions
                        }
                    });
                    document.dispatchEvent(event);
                    
                    // Resolver Promise ap√≥s m√≥dulo estar pronto
                    setTimeout(() => {
                        resolve();
                    }, 150);
                    return;
                }
            
            // Mostrar loading
            contentArea.innerHTML = `
                <div class="loading-container">
                    <i class="fas fa-spinner fa-spin loading-icon"></i>
                    <p class="loading-text">Carregando m√≥dulo...</p>
                </div>
            `;
            
            // Definir caminhos dos templates HTML externos
            const templatePaths = {
                'dashboard': 'modules/dashboard.html',
                'unidade': 'modules/unidade.html',
                'clientes': 'modules/clientes.html',
                'agenda': 'modules/agenda.html',
                'pos-venda': 'modules/pos-venda.html',
                'recrutamento': 'modules/recrutamento.html',
                'gestao-sistema': 'modules/gestao-sistema.html'
            };
            
            const templatePath = templatePaths[module];
            
            if (!templatePath) {
                contentArea.innerHTML = `
                    <div class="module-not-found-container">
                        <i class="fas fa-exclamation-circle module-not-found-icon"></i>
                        <h2 class="module-not-found-title">M√≥dulo n√£o encontrado</h2>
                        <p class="module-not-found-text">O m√≥dulo "${module}" n√£o foi encontrado.</p>
                        <p class="module-not-found-list">
                            M√≥dulos dispon√≠veis: ${Object.keys(templatePaths).join(', ')}
                        </p>
                    </div>
                `;
                reject(new Error(`M√≥dulo "${module}" n√£o encontrado`));
                return;
            }
            
            // Carregar template via AJAX
            fetch(templatePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(html => {
                    // Salvar no cache
                    templateCache.set(module, html);
                    
                    // Inserir o HTML carregado
                    contentArea.innerHTML = html;
                    
                    // Executar scripts inline do template carregado
                    const scripts = contentArea.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        newScript.onload = () => {
                            console.log('Script carregado:', script.src || 'inline');
                            
                            // Enviar dados para m√≥dulos espec√≠ficos ap√≥s carregamento
                            if (module === 'gestao-sistema') {
                                setTimeout(() => {
                                    sendModuleInitData(module);
                                }, 500);
                            }
                        };
                        document.head.appendChild(newScript);
                        script.remove();
                    });
                    
                    // Para m√≥dulos sem scripts externos, enviar dados imediatamente
                    if (scripts.length === 0) {
                        setTimeout(() => {
                            sendModuleInitData(module);
                        }, 100);
                    }
                    
                    // Disparar evento personalizado para inicializa√ß√£o do m√≥dulo
                    const event = new CustomEvent('moduleLoaded', {
                        detail: { 
                            module: module,
                            templatePath: templatePath,
                            fromCache: false,
                            timestamp: new Date().toISOString()
                        }
                    });
                    document.dispatchEvent(event);
                    
                    console.log(`‚úÖ M√≥dulo "${module}" carregado com sucesso`);
                    
                    // Resolver Promise ap√≥s m√≥dulo estar pronto
                    setTimeout(() => {
                        resolve();
                    }, 150);
                })
                .catch(error => {
                    console.error('‚ùå Erro ao carregar template:', error);
                    contentArea.innerHTML = `
                        <div class="module-error-container">
                            <i class="fas fa-exclamation-triangle module-error-icon"></i>
                            <h2 class="module-error-title">Erro ao carregar m√≥dulo</h2>
                            <p class="module-error-text">
                                N√£o foi poss√≠vel carregar o template: <strong>${templatePath}</strong>
                            </p>
                            <p class="module-error-details">
                                Erro: ${error.message}
                            </p>
                            <div class="module-error-actions">
                                <button onclick="loadModuleContent('${module}')" class="module-retry-button">
                                    <i class="fas fa-redo"></i> Tentar novamente
                                </button>
                                <button onclick="loadModuleContent('dashboard')" class="module-home-button">
                                    <i class="fas fa-home"></i> Voltar ao Dashboard
                                </button>
                            </div>
                        </div>
                    `;
                    reject(error);
                });
            }); // Fechar Promise
        }

        // Fun√ß√£o para enviar dados do usu√°rio para m√≥dulos carregados
        function sendModuleInitData(module) {
            console.log(`üì° Enviando dados de inicializa√ß√£o para o m√≥dulo: ${module}`);
            
            // Para m√≥dulos espec√≠ficos, enviar dados atrav√©s de vari√°veis globais
            if (module === 'gestao-sistema') {
                // Verificar se √© super_admin
                if (!currentUser || !userRole || userRole.name !== 'super_admin') {
                    console.warn('‚ö†Ô∏è Usu√°rio n√£o √© super_admin - bloqueando acesso ao gestao-sistema');
                    return;
                }
                
                // Disponibilizar dados para o m√≥dulo gestao-sistema via window
                window.moduleUserData = {
                    currentUser: currentUser,
                    userRole: userRole,
                    userUnits: userUnits,
                    supabase: supabase,
                    isDarkMode: document.body.classList.contains('dark')
                };
                
                // Tentar chamar fun√ß√£o de inicializa√ß√£o espec√≠fica se existir
                setTimeout(() => {
                    if (typeof window.GestaoSistema !== 'undefined' && typeof window.GestaoSistema.init === 'function') {
                        console.log('üéØ Inicializando m√≥dulo Gest√£o do Sistema via GestaoSistema.init()');  
                        window.GestaoSistema.init();
                    } else {
                        console.log('‚ö†Ô∏è Nenhuma fun√ß√£o de inicializa√ß√£o encontrada para gestao-sistema');
                        console.log('Available:', Object.keys(window).filter(key => key.includes('Gestao') || key.includes('gestao')));
                    }
                }, 200);
            } else if (module === 'dashboard') {
                // Disponibilizar dados para o dashboard
                window.dashboardData = {
                    currentUser: currentUser,
                    userRole: userRole,
                    userUnits: userUnits,
                    supabase: supabase,
                    selectedUnit: document.getElementById('unitSelect')?.value || null
                };
                
                // Garantir que a fun√ß√£o loadDashboardData esteja dispon√≠vel e execute
                setTimeout(() => {
                    if (typeof loadDashboardData === 'function') {
                        console.log('üéØ Carregando dados iniciais do dashboard');
                        loadDashboardData();
                    }
                }, 300);
            } else {
                // Para outros m√≥dulos, usar o sistema padr√£o
                const initFunctionName = `initialize${module.charAt(0).toUpperCase() + module.slice(1).replace('-', '')}`;
                
                if (typeof window[initFunctionName] === 'function') {
                    console.log(`üéØ Chamando fun√ß√£o de inicializa√ß√£o: ${initFunctionName}`);
                    try {
                        window[initFunctionName]();
                    } catch (error) {
                        console.error(`‚ùå Erro ao chamar ${initFunctionName}:`, error);
                    }
                }
            }
            
            console.log(`‚úÖ Dados enviados para m√≥dulo: ${module}`);
        }

        // Fun√ß√£o de logout ATUALIZADA
        async function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                // Mostrar loading
                const logoutBtn = document.getElementById('logoutBtn');
                const originalHTML = logoutBtn.innerHTML;
                logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                logoutBtn.disabled = true;
                
                try {
                    // ‚úÖ MELHORADO: Fazer logout do Supabase
                    await supabase.auth.signOut();
                    
                    // Limpar dados do usu√°rio
                    currentUser = null;
                    userUnits = [];
                    userRole = null;
                    availableModules = [];
                    unitModules = [];
                    
                    // Limpar localStorage
                    localStorage.removeItem('dromeflow_user');
                    
                    // Limpar cache de templates
                    templateCache.clear();
                    
                    // Resetar interface ANTES de mostrar modal
                    const contentArea = document.getElementById('contentArea');
                    if (contentArea) {
                        contentArea.innerHTML = `
                            <div class="welcome-container">
                                <div class="welcome-icon">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <h2 class="welcome-title">
                                    Bem-vindo ao DromeFlow
                                </h2>
                                <p class="welcome-description">
                                    Fa√ßa login para acessar o sistema de gest√£o completo.
                                </p>
                            </div>
                        `;
                    }
                    
                    // Resetar sidebar
                    const sidebarNav = document.querySelector('.sidebar-nav');
                    if (sidebarNav) {
                        sidebarNav.innerHTML = `
                            <div class="nav-item empty-state-nav">
                                <i class="fas fa-lock empty-state-icon"></i>
                                <p class="empty-state-text">Fa√ßa login para ver os m√≥dulos</p>
                            </div>
                        `;
                    }
                    
                    // Resetar informa√ß√µes do usu√°rio
                    const userAvatar = document.querySelector('.user-avatar');
                    const userName = document.querySelector('.user-name');
                    const userRoleElement = document.querySelector('.user-role');
                    
                    if (userAvatar) userAvatar.textContent = 'U';
                    if (userName) userName.textContent = 'Usu√°rio';
                    if (userRoleElement) userRoleElement.textContent = 'Fa√ßa login';
                    
                    // Limpar formul√°rio de login
                    const loginForm = document.getElementById('loginForm');
                    const errorMessage = document.getElementById('errorMessage');
                    const successMessage = document.getElementById('successMessage');
                    
                    if (loginForm) loginForm.reset();
                    if (errorMessage) errorMessage.style.display = 'none';
                    if (successMessage) successMessage.style.display = 'none';
                    
                    // Mostrar modal de login usando fun√ß√£o auxiliar
                    openLoginModal();
                    
                    // Remover active dos links
                    document.querySelectorAll('.nav-link, .submenu-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    // ‚úÖ MELHORADO: Limpar dados da interface
                    const unitSelect = document.getElementById('unitSelect');
                    if (unitSelect) {
                        unitSelect.innerHTML = '<option value="">Selecione uma unidade</option>';
                    }
                    
                    // Resetar t√≠tulo
                    const pageTitle = document.getElementById('pageTitle');
                    if (pageTitle) pageTitle.textContent = 'DromeFlow';
                    
                    console.log('‚úÖ Logout realizado com sucesso');
                    
                } catch (error) {
                    console.error('Erro no logout:', error);
                } finally {
                    // Restaurar bot√£o
                    logoutBtn.innerHTML = originalHTML;
                    logoutBtn.disabled = false;
                }
            }
        }

        // Inicializa√ß√£o responsiva
        function initializeResponsiveLayout() {
            if (window.innerWidth <= 768) {
                // Mobile: sidebar fechada por padr√£o
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('mobile-open');
            } else {
                // Desktop: manter estado normal
                sidebar.classList.remove('mobile-open');
            }
        }

        // Inicializar layout responsivo
        initializeResponsiveLayout();

        // Carregar dashboard por padr√£o APENAS se usu√°rio estiver logado
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (currentUser) {
                    loadModuleContent('dashboard');
                }
            }, 100);
        });

        // Fun√ß√£o para limpar cache (√∫til para desenvolvimento)
        function clearTemplateCache() {
            templateCache.clear();
            console.log('üóëÔ∏è Cache de templates limpo');
        }

        // Fun√ß√£o para recarregar m√≥dulo for√ßadamente (ignora cache)
        function reloadModule(module) {
            templateCache.delete(module);
            loadModuleContent(module);
        }

        // === Fun√ß√µes do Novo Header ===
        
        // Fun√ß√£o para abrir modal de upload
        // Fun√ß√£o removida - usando abrirModalUpload() mais completa

        // Fun√ß√£o para resetar formul√°rio de upload
        function resetUploadForm() {
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
        }

        // Fun√ß√£o para mostrar notifica√ß√µes
        function showNotification(message, type = 'info') {
            // Criar elemento de notifica√ß√£o se n√£o existir
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 9999;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                    max-width: 300px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                `;
                document.body.appendChild(notification);
            }

            // Definir cor baseada no tipo
            const colors = {
                success: '#10B981',
                error: '#EF4444',
                warning: '#F59E0B',
                info: '#3B82F6'
            };

            notification.style.backgroundColor = colors[type] || colors.info;
            notification.textContent = message;

            // Mostrar notifica√ß√£o
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Ocultar ap√≥s 3 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
            }, 3000);

            console.log(`üì¢ Notifica√ß√£o [${type.toUpperCase()}]:`, message);
        }

        // Fun√ß√£o para processar arquivo
        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Por favor, selecione um arquivo.', 'error');
                return;
            }

            if (!file.name.endsWith('.xlsx')) {
                showNotification('Por favor, selecione apenas arquivos .xlsx', 'error');
                return;
            }

            // Simular upload com progresso
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');
            
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('uploadProgress').classList.remove('hidden');

            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) {
                    progress = 100;
                    clearInterval(interval);
                    uploadStatus.textContent = 'Upload conclu√≠do!';
                    setTimeout(() => {
                        showNotification('Arquivo enviado com sucesso!', 'success');
                        closeUploadModal();
                    }, 1000);
                }
                progressFill.style.width = progress + '%';
                uploadStatus.textContent = `Enviando... ${Math.round(progress)}%`;
            }, 200);
        }

        // Fun√ß√£o de altern√¢ncia de tema para o header
        function headerToggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Atualizar √≠cone do bot√£o de tema
            updateThemeIcon();
        }

        // Fun√ß√£o para atualizar √≠cone do tema
        function updateThemeIcon() {
            const themeBtn = document.getElementById('headerThemeToggle');
            const currentTheme = document.body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                themeBtn.title = 'Alternar para tema claro';
            } else {
                themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                themeBtn.title = 'Alternar para tema escuro';
            }
        }

        // Fun√ß√£o para atualizar dados
        function refreshData() {
            console.log('üîÑ Atualiza√ß√£o de dados solicitada...');
            
            // Implementar l√≥gica espec√≠fica de atualiza√ß√£o sem alertas
            const currentModule = getCurrentModule();
            if (currentModule) {
                // Recarregar m√≥dulo atual
                templateCache.delete(currentModule);
                loadModuleContent(currentModule);
                
                // Se for dashboard, tamb√©m atualizar dados
                if (currentModule === 'dashboard' && typeof loadDashboardData === 'function') {
                    loadDashboardData();
                }
                
                console.log(`‚úÖ M√≥dulo "${currentModule}" atualizado silenciosamente`);
            } else {
                console.log('‚ÑπÔ∏è Nenhum m√≥dulo ativo para atualizar');
            }
        }

        // Fun√ß√£o para obter m√≥dulo atual
        function getCurrentModule() {
            const activeLink = document.querySelector('.sidebar-link.active, .submenu-link.active');
            return activeLink ? activeLink.dataset.module : null;
        }

        // Fun√ß√£o para obter unidade selecionada
        function getSelectedUnit() {
            const unitSelect = document.getElementById('unitSelect');
            if (!unitSelect || !unitSelect.value) return null;
            
            const selectedUnit = userUnits.find(unit => unit.id === unitSelect.value);
            return selectedUnit || null;
        }

        // === FUN√á√ïES DE UPLOAD XLSX - Baseado no Dash Resultados ===
        let uploadedData = null;

        // Fun√ß√£o para abrir modal de upload
        function abrirModalUpload() {
            console.log('üîÑ Tentando abrir modal de upload...');
            const modal = document.getElementById('uploadModal');
            console.log('üìÇ Modal encontrado:', modal);
            
            if (modal) {
                console.log('‚úÖ Removendo classe hidden do modal');
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                console.log('üéØ Classes do modal ap√≥s abertura:', modal.className);
                console.log('üìã Modal vis√≠vel:', !modal.classList.contains('hidden'));
                
                // Reset do modal ao abrir
                resetUploadModal();
            } else {
                console.error('‚ùå Modal uploadModal n√£o encontrado no DOM');
            }
        }

        // Fun√ß√£o para fechar modal de upload
        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
            // Reset completo do modal
            resetUploadModal();
        }

        // Fun√ß√£o para resetar modal de upload
        function resetUploadModal() {
            const xlsxInput = document.getElementById('xlsxInput');
            const uploadPreview = document.getElementById('uploadPreview');
            const uploadStatus = document.getElementById('uploadStatus');
            const processFileBtn = document.getElementById('processFile');
            const fileName = document.getElementById('fileName');
            const fileInfo = document.getElementById('fileInfo');
            
            if (xlsxInput) xlsxInput.value = '';
            if (uploadPreview) uploadPreview.classList.add('hidden');
            if (uploadStatus) uploadStatus.classList.add('hidden');
            if (processFileBtn) processFileBtn.disabled = true;
            if (fileName) fileName.textContent = '';
            if (fileInfo) fileInfo.textContent = '';
        }

        // Fun√ß√£o para limpar sele√ß√£o de arquivo
        function clearFileSelection() {
            console.log('üóëÔ∏è Limpando sele√ß√£o de arquivo...');
            resetUploadModal();
        }

        // Fun√ß√£o para mostrar preview do arquivo
        function showFilePreview(file) {
            console.log('üìÑ Mostrando preview do arquivo:', file.name);
            
            const fileName = document.getElementById('fileName');
            const fileInfo = document.getElementById('fileInfo');
            const uploadPreview = document.getElementById('uploadPreview');
            const processFileBtn = document.getElementById('processFile');
            
            if (fileName) fileName.textContent = file.name;
            if (fileInfo) fileInfo.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
            if (uploadPreview) uploadPreview.classList.remove('hidden');
            if (processFileBtn) processFileBtn.disabled = false;
            
            // Limpar status anterior
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) uploadStatus.classList.add('hidden');
        }

        // Fun√ß√£o para mostrar status do upload
        function showUploadStatus(message, type = 'info') {
            console.log(`üì¢ Status [${type.toUpperCase()}]:`, message);
            
            const uploadStatus = document.getElementById('uploadStatus');
            const statusMessage = document.getElementById('statusMessage');
            
            if (uploadStatus && statusMessage) {
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type}`;
                uploadStatus.classList.remove('hidden');
            }
        }

        // Handlers de drag and drop
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.toLowerCase().endsWith('.xlsx')) {
                    document.getElementById('xlsxInput').files = files;
                    showFilePreview(file);
                } else {
                    showUploadStatus('Por favor, solte apenas arquivos XLSX v√°lidos.', 'error');
                }
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.name.toLowerCase().endsWith('.xlsx')) {
                    showFilePreview(file);
                } else {
                    showUploadStatus('Por favor, selecione apenas arquivos XLSX v√°lidos.', 'error');
                    e.target.value = '';
                }
            }
        }

        // Fun√ß√µes auxiliares de processamento
        function parseValueFromCurrency(value) {
            if (typeof value === 'number' && !isNaN(value)) return value;
            if (typeof value !== 'string') return 0;
            
            const cleanValue = value
                .replace(/[^\d,.-]/g, '')
                .replace(/,/g, '.');
            
            const parsed = parseFloat(cleanValue);
            return isNaN(parsed) ? 0 : parsed;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Se j√° est√° no formato ISO (YYYY-MM-DD), usar Date
            if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return new Date(dateStr + 'T00:00:00');
            }
            
            // Se √© uma string DD/MM/YYYY, converter
            if (typeof dateStr === 'string' && dateStr.includes('/')) {
                const [day, month, year] = dateStr.split('/');
                return new Date(year, month - 1, day);
            }
            
            // Tentar converter diretamente
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        // Fun√ß√£o para mostrar status de upload
        function showUploadStatus(message, type = 'info') {
            const uploadStatus = document.getElementById('uploadStatus');
            const statusMessage = document.getElementById('statusMessage');
            
            if (uploadStatus && statusMessage) {
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type}`;
                uploadStatus.classList.remove('hidden');
            }
        }

        // Handlers de drag and drop
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.xlsx')) {
                document.getElementById('xlsxInput').files = files;
                showFilePreview(files[0]);
            } else {
                showUploadStatus('Por favor, solte um arquivo XLSX v√°lido.', 'error');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.name.toLowerCase().endsWith('.xlsx')) {
                showFilePreview(file);
            } else {
                showUploadStatus('Por favor, selecione um arquivo XLSX v√°lido.', 'error');
            }
        }

        function showFilePreview(file) {
            const fileName = document.getElementById('fileName');
            const fileInfo = document.getElementById('fileInfo');
            const uploadPreview = document.getElementById('uploadPreview');
            const processFileBtn = document.getElementById('processFile');
            
            if (fileName) fileName.textContent = file.name;
            if (fileInfo) fileInfo.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
            if (uploadPreview) uploadPreview.classList.remove('hidden');
            if (processFileBtn) processFileBtn.disabled = false;
        }

        // Fun√ß√£o principal de processamento do arquivo
        async function processUploadedFile() {
            const file = document.getElementById('xlsxInput').files[0];
            if (!file) {
                showUploadStatus('Nenhum arquivo selecionado para processar.', 'warning');
                return;
            }
            
            showUploadStatus('Processando arquivo...', 'info');
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // A planilha tem headers na linha 2, e os dados come√ßam na linha 3 (√≠ndice 2)
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                        if (json.length <= 2) {
                            showUploadStatus('Dados insuficientes no arquivo.', 'error');
                            return;
                        }

                        const headers = json[1]; // A linha 2 da planilha (√≠ndice 1) cont√©m os cabe√ßalhos
                        const dataRows = json.slice(2); // Os dados come√ßam na linha 3 (√≠ndice 2)
                        
                        console.log('Cabe√ßalhos da planilha:', headers);

                        // Mapeamento de colunas da planilha para nomes do DB/c√≥digo
                        const colMapping = {
                            'N√∫mero': headers.indexOf('N√∫mero'),
                            'Data': headers.indexOf('Data'),
                            'Hor√°rio': headers.indexOf('Hor√°rio'),
                            'Per√≠odo': headers.indexOf('Per√≠odo'),
                            'Servi√ßo': headers.indexOf('Servi√ßo'),
                            'Tipo': headers.indexOf('Tipo'),
                            'Cliente': headers.indexOf('Cliente'),
                            'Profissionais': headers.indexOf('Profissionais'),
                            'Repasse (R$)': headers.indexOf('Repasse (R$)'),
                            'Local de Atendimento': headers.indexOf('Local de Atendimento'),
                            'Valor (R$)': headers.indexOf('Valor (R$)'),
                            'Cupom de Desconto': headers.indexOf('Cupom de Desconto'),
                            'Origem': headers.indexOf('Origem'),
                            'Data de cadastro': headers.indexOf('Data de cadastro'),
                            'Dia da semana': headers.indexOf('Dia da semana')
                        };
                        
                        // Verificar se alguma coluna obrigat√≥ria est√° faltando
                        const colunasObrigatorias = ['Data', 'Cliente', 'Valor (R$)', 'Servi√ßo'];
                        const colunasFaltantes = colunasObrigatorias.filter(col => colMapping[col] === -1);
                        if (colunasFaltantes.length > 0) {
                            showUploadStatus(`Erro: Colunas obrigat√≥rias n√£o encontradas: ${colunasFaltantes.join(', ')}`, 'error');
                            return;
                        }

                        let resultados = [];
                        dataRows.forEach(row => {
                            let base = {};
                            // Preencher 'base' com os valores do XLSX usando os cabe√ßalhos
                            base['DATA'] = (row[colMapping['Data']] || '').toString().trim();
                            base['HORARIO'] = (row[colMapping['Hor√°rio']] || '').toString().trim();
                            base['PER√çODO'] = (row[colMapping['Per√≠odo']] || '').toString().trim();
                            base['SERVI√áO'] = (row[colMapping['Servi√ßo']] || '').toString().trim();
                            base['TIPO'] = (row[colMapping['Tipo']] || '').toString().trim();
                            base['CLIENTE'] = (row[colMapping['Cliente']] || '').toString().trim();
                            // Remover barra vertical e espa√ßos ao final do nome do cliente
                            base['CLIENTE'] = base['CLIENTE'].replace(/\|/g, '').trim();
                            base['PROFISSIONAL'] = (row[colMapping['Profissionais']] || '').toString().trim();
                            
                            // Valores num√©ricos - garante que s√£o n√∫meros v√°lidos
                            const repasse = parseValueFromCurrency(row[colMapping['Repasse (R$)']] || '0');
                            const valor = parseValueFromCurrency(row[colMapping['Valor (R$)']] || '0');
                            base['REPASSE'] = isNaN(repasse) ? 0 : repasse; 
                            base['VALOR'] = isNaN(valor) ? 0 : valor;
                            
                            base['CUPOM'] = (row[colMapping['Cupom de Desconto']] || '').toString().trim();
                            base['ORIGEM'] = (row[colMapping['Origem']] || '').toString().trim();
                            base['ENDERE√áO'] = (row[colMapping['Local de Atendimento']] || '').toString().trim();
                            base['CADASTRO'] = (row[colMapping['Data de cadastro']] || '').toString().trim();
                            base['DIA'] = (row[colMapping['Dia da semana']] || '').toString().trim();
                            base['N√öMERO'] = (row[colMapping['N√∫mero']] || '').toString().trim();

                            // Convers√£o de formato de data para YYYY-MM-DD
                            if (base['DATA'] && base['DATA'].includes('/')) {
                                const [day, month, year] = base['DATA'].split('/');
                                base['DATA'] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            }
                            if (base['CADASTRO'] && base['CADASTRO'].includes('/')) {
                                const [day, month, year] = base['CADASTRO'].split('/');
                                base['CADASTRO'] = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                            }

                            // Processar cliente e telefone
                            let cliente = base['CLIENTE'] || '';
                            let telefone = '';
                            const telMatch = cliente.match(/\(?\d{2}\)? ?\d{4,5}-?\d{4}/);
                            if (telMatch) {
                                telefone = telMatch[0].replace(/\D/g, '');
                                cliente = cliente.replace(telMatch[0], '').trim();
                            }
                            base['CLIENTE'] = cliente;
                            base['whatscliente'] = telefone ? `55${telefone}` : '';

                            // Handle multiple professionals and IS_DIVISAO
                            let profissionais = (base['PROFISSIONAL'] || '').split(';').map(p => p.trim()).filter(Boolean);
                            if (profissionais.length === 0) profissionais = ['SEM PROFISSIONAL'];

                            const atendimentoId = base['N√öMERO'] || `${base['DATA']}_${base['CLIENTE']}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            const repasseDividido = profissionais.length > 1 ? (base['REPASSE'] / profissionais.length) : base['REPASSE'];

                            profissionais.forEach((prof, index) => {
                                let newEntry = {
                                    ...base,
                                    PROFISSIONAL: prof,
                                    ATENDIMENTO_ID: atendimentoId,
                                    IS_DIVISAO: profissionais.length > 1 ? (index > 0 ? 'SIM' : 'NAO') : 'NAO',
                                    REPASSE: repasseDividido
                                };
                                resultados.push(newEntry);
                            });
                        });

                        if (resultados.length === 0) {
                            showUploadStatus('Nenhum dado v√°lido encontrado para upload.', 'error');
                            return;
                        }

                        console.log(`${resultados.length} registros processados. Amostra:`, resultados.slice(0, 3));
                        showUploadStatus(`${resultados.length} registros processados.`, 'success');
                        
                        // Simular upload para database
                        await uploadToDatabase(resultados);

                    } catch (err) {
                        console.error('Error processing XLSX data:', err);
                        showUploadStatus('Erro ao processar arquivo: ' + err.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error in processUploadedFile:', error);
                showUploadStatus('Erro no upload: ' + error.message, 'error');
            }
        }

        // Fun√ß√£o para fazer upload para o banco de dados
        async function uploadToDatabase(records) {
            showUploadStatus('Salvando no banco de dados...', 'info');
            
            try {
                // Verificar se usu√°rio est√° logado e tem unidade selecionada
                if (!currentUser || !currentUser.id) {
                    throw new Error('Usu√°rio n√£o est√° logado');
                }

                const selectedUnit = getSelectedUnit();
                if (!selectedUnit || !selectedUnit.id) {
                    throw new Error('Nenhuma unidade selecionada. Por favor, selecione uma unidade antes de fazer o upload.');
                }

                console.log('üì§ Iniciando upload para banco:', {
                    user_id: currentUser.id,
                    unit_id: selectedUnit.id,
                    records_count: records.length
                });

                // üîß CORRE√á√ÉO: Mapeamento mais rigoroso para a estrutura da tabela
                const mappedRecords = records.map((record, index) => {
                    // Converter datas para formato ISO se necess√°rio
                    let dataFormatted = null;
                    if (record.DATA) {
                        if (record.DATA.includes('-')) {
                            dataFormatted = record.DATA; // J√° est√° no formato correto
                        } else if (record.DATA.includes('/')) {
                            const [day, month, year] = record.DATA.split('/');
                            dataFormatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        }
                    }

                    let cadastroFormatted = null;
                    if (record.CADASTRO && record.CADASTRO.trim() !== '') {
                        if (record.CADASTRO.includes('-')) {
                            cadastroFormatted = record.CADASTRO;
                        } else if (record.CADASTRO.includes('/')) {
                            const [day, month, year] = record.CADASTRO.split('/');
                            cadastroFormatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                        }
                    }

                    // üîß CORRE√á√ÉO: Garantir que valores num√©ricos sejam v√°lidos
                    const valor = parseFloat(record.VALOR) || 0;
                    const repasse = parseFloat(record.REPASSE) || 0;

                    const mappedRecord = {
                        // Campos de data
                        data: dataFormatted,
                        cadastro: cadastroFormatted,
                        
                        // Campos de texto (limitar tamanho se necess√°rio)
                        horario: record.HORARIO ? record.HORARIO.toString().substring(0, 255) : null,
                        servico: record.SERVI√áO ? record.SERVI√áO.toString().substring(0, 255) : null,
                        tipo: record.TIPO ? record.TIPO.toString().substring(0, 255) : null,
                        periodo: record.PER√çODO ? record.PER√çODO.toString().substring(0, 255) : null,
                        cliente: record.CLIENTE ? record.CLIENTE.toString().substring(0, 255) : null,
                        profissional: record.PROFISSIONAL ? record.PROFISSIONAL.toString().substring(0, 255) : null,
                        endereco: record.ENDERE√áO ? record.ENDERE√áO.toString().substring(0, 500) : null,
                        dia: record.DIA ? record.DIA.toString().substring(0, 255) : null,
                        whatscliente: record.whatscliente ? record.whatscliente.toString().substring(0, 255) : null,
                        cupom: record.CUPOM ? record.CUPOM.toString().substring(0, 255) : null,
                        origem: record.ORIGEM ? record.ORIGEM.toString().substring(0, 255) : null,
                        atendimento_id: record.ATENDIMENTO_ID ? record.ATENDIMENTO_ID.toString().substring(0, 255) : null,
                        is_divisao: record.IS_DIVISAO ? record.IS_DIVISAO.toString().substring(0, 10) : 'NAO',
                        
                        // Campos num√©ricos - garantir que s√£o n√∫meros v√°lidos
                        valor: !isNaN(valor) ? valor : 0,
                        repasse: !isNaN(repasse) ? repasse : 0,
                        
                        // Campos obrigat√≥rios do sistema
                        user_id: currentUser.id,
                        unit_id: selectedUnit.id,
                        
                        // Campos opcionais com valores padr√£o
                        acao: null,
                        horas: null,
                        motivo: null,
                        acomp: null,
                        status: 'ATIVO',
                        pos: null,
                        observacao: null
                    };

                    // üîß LOG detalhado para debug
                    if (index < 3) {
                        console.log(`üìã Registro ${index + 1} mapeado:`, {
                            original_data: record.DATA,
                            formatted_data: mappedRecord.data,
                            cliente: mappedRecord.cliente,
                            valor: mappedRecord.valor,
                            user_id: mappedRecord.user_id,
                            unit_id: mappedRecord.unit_id
                        });
                    }

                    return mappedRecord;
                });

                console.log('ÔøΩ Dados mapeados:', {
                    total: mappedRecords.length,
                    amostra: mappedRecords.slice(0, 2),
                    unit_id: selectedUnit.id,
                    user_id: currentUser.id
                });

                // üîß NOVA: Valida√ß√£o antes do insert
                const invalidRecords = mappedRecords.filter(record => 
                    !record.user_id || !record.unit_id || !record.data
                );

                if (invalidRecords.length > 0) {
                    console.error('‚ùå Registros inv√°lidos encontrados:', invalidRecords.slice(0, 3));
                    throw new Error(`${invalidRecords.length} registros t√™m dados obrigat√≥rios faltando`);
                }

                // Deletar registros do mesmo m√™s/ano antes de inserir (se houver dados com data)
                if (mappedRecords.length > 0 && mappedRecords[0].data) {
                    const dataStr = mappedRecords[0].data;
                    const [ano, mes] = dataStr.split('-');
                    
                    if (ano && mes) {
                        showUploadStatus('Removendo dados anteriores do mesmo per√≠odo...', 'info');
                        
                        try {
                            console.log(`üóëÔ∏è Deletando registros de ${mes}/${ano} para unidade ${selectedUnit.id}`);
                            
                            const { data: deletedData, error: deleteError } = await supabase
                                .from('resultados')
                                .delete()
                                .eq('unit_id', selectedUnit.id)
                                .gte('data', `${ano}-${mes}-01`)
                                .lte('data', `${ano}-${mes}-31`);
                            
                            if (deleteError) {
                                console.warn('‚ö†Ô∏è Aviso ao deletar registros anteriores:', deleteError);
                            } else {
                                console.log('‚úÖ Registros anteriores removidos com sucesso');
                            }
                        } catch (deleteErr) {
                            console.warn('‚ö†Ô∏è Erro n√£o cr√≠tico ao deletar registros anteriores:', deleteErr);
                        }
                    }
                }

                // üîß CORRE√á√ÉO: Inserir em lotes menores para evitar timeout
                showUploadStatus('Inserindo novos registros...', 'info');
                
                const BATCH_SIZE = 100; // Inserir 100 registros por vez
                let insertedCount = 0;
                
                for (let i = 0; i < mappedRecords.length; i += BATCH_SIZE) {
                    const batch = mappedRecords.slice(i, i + BATCH_SIZE);
                    
                    console.log(`üì§ Inserindo lote ${Math.floor(i/BATCH_SIZE) + 1}/${Math.ceil(mappedRecords.length/BATCH_SIZE)} (${batch.length} registros)`);
                    
                    try {
                        const { data: insertedData, error: insertError } = await supabase
                            .from('resultados')
                            .insert(batch);

                        if (insertError) {
                            console.error('‚ùå Erro no Supabase insert (lote):', insertError);
                            console.error('üìã Dados do lote com erro:', batch.slice(0, 2));
                            throw new Error(`Erro ao salvar lote ${Math.floor(i/BATCH_SIZE) + 1}: ${insertError.message}`);
                        }
                        
                        insertedCount += batch.length;
                        console.log(`‚úÖ Lote ${Math.floor(i/BATCH_SIZE) + 1} inserido com sucesso (${batch.length} registros)`);
                        
                        // Atualizar status do progresso
                        const progress = Math.round((insertedCount / mappedRecords.length) * 100);
                        showUploadStatus(`Salvando... ${progress}% (${insertedCount}/${mappedRecords.length})`, 'info');
                        
                    } catch (batchError) {
                        console.error('‚ùå Erro cr√≠tico no lote:', batchError);
                        throw batchError;
                    }
                }
                
                console.log('‚úÖ Todos os registros inseridos com sucesso:', insertedCount);

                showUploadStatus('Upload conclu√≠do com sucesso!', 'success');
                showNotification(`${insertedCount} registros salvos com sucesso na unidade ${selectedUnit.name}!`, 'success');
                
                // Recarregar dados do dashboard se estiver ativo
                setTimeout(() => {
                    const currentModule = getCurrentModule();
                    if (currentModule === 'dashboard' && typeof loadDashboardData === 'function') {
                        loadDashboardData();
                    }
                    closeUploadModal();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro no upload para banco de dados:', error);
                showUploadStatus(`Erro: ${error.message}`, 'error');
                showNotification(`Falha ao salvar: ${error.message}`, 'error');
                
                // üîß LOG adicional para debug
                console.log('üîç Debug info:', {
                    currentUser: currentUser,
                    selectedUnit: getSelectedUnit(),
                    recordsCount: records?.length,
                    supabaseAvailable: !!supabase
                });
            }
        }

        // Fun√ß√£o para mostrar status do upload
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            if (!statusDiv) return;
            
            statusDiv.className = `mt-4 p-3 rounded-lg ${
                type === 'error' ? 'bg-danger-color text-on-accent' :
                type === 'success' ? 'bg-success-color text-on-accent' :
                'bg-info-color text-on-accent'
            }`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        // Fun√ß√£o para obter filtros ativos
        function getActiveFilters() {
            const unitSelect = document.getElementById('unitSelect');
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            return {
                unitId: unitSelect?.value || null,
                unitName: getSelectedUnit()?.name || null,
                month: monthFilter?.value || null,
                year: yearFilter?.value || null,
                monthName: monthFilter?.selectedOptions[0]?.textContent || null
            };
        }

        // Fun√ß√£o para notificar mudan√ßa de filtros
        function notifyFilterChange() {
            const filters = getActiveFilters();
            console.log('üîç Filtros alterados:', filters);
            
            // Disparar evento personalizado para que os m√≥dulos possam reagir
            const event = new CustomEvent('filtersChanged', {
                detail: filters
            });
            document.dispatchEvent(event);
            
            // Recarregar m√≥dulo atual se necess√°rio
            const currentModule = getCurrentModule();
            if (currentModule && filters.unitId) {
                console.log(`üîÑ Aplicando filtros ao m√≥dulo: ${currentModule}`);
                // Voc√™ pode implementar l√≥gica espec√≠fica aqui
            }
        }

        // Event Listeners para o novo header
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß DOM carregado - Configurando modal de upload...');
            
            // Testar se o modal existe
            const uploadModal = document.getElementById('uploadModal');
            console.log('üìÇ Modal de upload encontrado:', uploadModal ? 'SIM' : 'N√ÉO');
            
            // Testar biblioteca XLSX
            console.log('üìö Biblioteca XLSX dispon√≠vel:', typeof XLSX !== 'undefined' ? 'SIM' : 'N√ÉO');
            
            // Upload XLSX modal events
            const dropZone = document.getElementById('dropZone');
            const xlsxInput = document.getElementById('xlsxInput');

            if (dropZone) {
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);
            }

            if (xlsxInput) {
                xlsxInput.addEventListener('change', handleFileSelect);
            }

            // Fechar modal ao clicar no backdrop e configurar Escape
            if (uploadModal) {
                uploadModal.addEventListener('click', (e) => {
                    if (e.target === uploadModal) {
                        closeUploadModal();
                    }
                });
            }

            // Fechar modal com tecla Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (uploadModal && !uploadModal.classList.contains('hidden')) {
                        closeUploadModal();
                    }
                }
            });

            // Header button events
            const headerThemeToggle = document.getElementById('headerThemeToggle');
            const unitSelect = document.getElementById('unitSelect');
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');

            // Refresh button j√° configurado anteriormente no c√≥digo principal
            
            if (headerThemeToggle) {
                headerThemeToggle.addEventListener('click', headerToggleTheme);
            }

            // Filter change events
            if (unitSelect) {
                unitSelect.addEventListener('change', (e) => {
                    const selectedUnit = getSelectedUnit();
                    console.log('üè¢ Unidade selecionada:', selectedUnit);
                    
                    if (selectedUnit) {
                        // Salvar √∫ltima unidade selecionada
                        localStorage.setItem('lastSelectedUnit', selectedUnit.id);
                        console.log('üíæ Unidade salva no localStorage:', selectedUnit.name);
                    }
                    
                    // Notificar mudan√ßa de filtros
                    notifyFilterChange();
                });
            }

            if (monthFilter) {
                monthFilter.addEventListener('change', (e) => {
                    const monthName = e.target.selectedOptions[0]?.textContent || 'Todos';
                    console.log('üìÖ M√™s selecionado:', monthName, '(valor:', e.target.value, ')');
                    notifyFilterChange();
                });
            }

            if (yearFilter) {
                yearFilter.addEventListener('change', (e) => {
                    console.log('üìÖ Ano selecionado:', e.target.value || 'Todos');
                    notifyFilterChange();
                });
            }

            // Inicializar tema
            updateThemeIcon();
            
            // Inicializar filtros com m√™s e ano atual
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() retorna 0-11
            const currentYear = currentDate.getFullYear();
            
            if (monthFilter) {
                monthFilter.value = currentMonth.toString();
            }
            
            if (yearFilter) {
                yearFilter.value = currentYear.toString();
            }
            
            // Verificar se h√° sess√£o ativa e popular unidades
            const savedUser = localStorage.getItem('dromeflow_user');
            if (savedUser) {
                populateUnitSelect();
            }

            // Listener global para mudan√ßas de filtros
            document.addEventListener('filtersChanged', (e) => {
                const filters = e.detail;
                console.log('üéØ Sistema notificado sobre mudan√ßa de filtros:', filters);
                
                // Aqui voc√™ pode implementar l√≥gica global que deve reagir a mudan√ßas de filtros
                // Por exemplo: atualizar dashboards, recarregar dados, etc.
            });
        });

        // Fun√ß√£o para conceder/remover acesso de m√≥dulo para usu√°rio (apenas admins)
        async function toggleUserModuleAccess(userId, unitId, moduleId, grant = true) {
            try {
                if (userRole?.name !== 'admin' && userRole?.name !== 'super_admin') {
                    throw new Error('Sem permiss√£o para alterar acessos');
                }

                if (grant) {
                    // Conceder acesso
                    const { error } = await supabase
                        .from('user_module_permissions')
                        .insert({
                            user_id: userId,
                            unit_id: unitId,
                            module_id: moduleId,
                            granted_by: currentUser.id
                        });

                    if (error && error.code !== '23505') { // Ignora erro de duplicata
                        throw error;
                    }

                    console.log('‚úÖ Acesso concedido ao m√≥dulo');
                } else {
                    // Remover acesso
                    const { error } = await supabase
                        .from('user_module_permissions')
                        .delete()
                        .eq('user_id', userId)
                        .eq('unit_id', unitId)
                        .eq('module_id', moduleId);

                    if (error) throw error;

                    console.log('‚ùå Acesso removido do m√≥dulo');
                }

                return { success: true };
                
            } catch (error) {
                console.error('Erro ao alterar acesso:', error);
                return { success: false, error: error.message };
            }
        }

        // Fun√ß√£o para ativar/desativar m√≥dulo na unidade (apenas super admin)
        async function toggleUnitModule(unitId, moduleId, enable = true) {
            try {
                if (userRole?.name !== 'super_admin') {
                    throw new Error('Apenas Super Admin pode alterar m√≥dulos de unidades');
                }

                if (enable) {
                    // Ativar m√≥dulo na unidade
                    const { error } = await supabase
                        .from('unit_modules')
                        .insert({
                            unit_id: unitId,
                            module_id: moduleId,
                            enabled_by: currentUser.id
                        });

                    if (error && error.code !== '23505') { // Ignora erro de duplicata
                        throw error;
                    }

                    console.log('‚úÖ M√≥dulo ativado na unidade');
                } else {
                    // Desativar m√≥dulo na unidade
                    const { error } = await supabase
                        .from('unit_modules')
                        .delete()
                        .eq('unit_id', unitId)
                        .eq('module_id', moduleId);

                    if (error) throw error;

                    // Remover todas as permiss√µes de usu√°rios para este m√≥dulo nesta unidade
                    await supabase
                        .from('user_module_permissions')
                        .delete()
                        .eq('unit_id', unitId)
                        .eq('module_id', moduleId);

                    console.log('‚ùå M√≥dulo desativado na unidade');
                }

                return { success: true };
                
            } catch (error) {
                console.error('Erro ao alterar m√≥dulo da unidade:', error);
                return { success: false, error: error.message };
            }
        }

        // Adicionar fun√ß√£o ao escopo global para debug e gest√£o
        window.DromeFlow = {
            clearCache: clearTemplateCache,
            reloadModule: reloadModule,
            getCache: () => Array.from(templateCache.keys()),
            version: '2.0.0',
            // Novas fun√ß√µes para debug de permiss√µes
            getUserPermissions: () => availableModules,
            getAvailableModules: () => availableModules,
            getUserRole: () => userRole,
            getCurrentUser: () => currentUser,
            hasPermission: hasPermission,
            canAccessModule: canAccessModule,
            // Fun√ß√µes para gest√£o (apenas admins)
            toggleUserModuleAccess: toggleUserModuleAccess,
            toggleUnitModule: toggleUnitModule,
            // Debug functions
            debug: {
                showUserInfo: () => {
                    console.log('=== INFORMA√á√ïES DO USU√ÅRIO ===');
                    console.log('Usu√°rio:', currentUser);
                    console.log('Papel:', userRole);
                    console.log('Unidades:', userUnits);
                    console.log('M√≥dulos dispon√≠veis:', availableModules.length);
                    console.log('Lista de m√≥dulos:', availableModules.map(m => `${m.name} (${m.display_name})`));
                },
                testPermission: (moduleName) => {
                    const result = canAccessModule(moduleName);
                    console.log(`Pode acessar "${moduleName}":`, result);
                    return result;
                }
            }
        };

        // üîß Fun√ß√£o de debug para testar filtros do Dashboard
        window.debugDashboardFilters = function() {
            console.log('=== DEBUG FILTROS DASHBOARD ===');
            
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            const unitSelect = document.getElementById('unitSelect');
            
            console.log('Elementos encontrados:');
            console.log('- monthFilter:', !!monthFilter, monthFilter?.value);
            console.log('- yearFilter:', !!yearFilter, yearFilter?.value);
            console.log('- unitSelect:', !!unitSelect, unitSelect?.value);
            
            if (monthFilter) {
                console.log('M√™s selecionado:', {
                    value: monthFilter.value,
                    text: monthFilter.selectedOptions[0]?.textContent,
                    options: Array.from(monthFilter.options).map(o => ({ value: o.value, text: o.textContent }))
                });
            }
            
            if (yearFilter) {
                console.log('Ano selecionado:', {
                    value: yearFilter.value,
                    text: yearFilter.selectedOptions[0]?.textContent,
                    options: Array.from(yearFilter.options).map(o => ({ value: o.value, text: o.textContent }))
                });
            }
            
            // Testar fun√ß√£o getDashboardFilters
            if (typeof getDashboardFilters === 'function') {
                console.log('Filtros via getDashboardFilters():', getDashboardFilters());
            } else {
                console.error('Fun√ß√£o getDashboardFilters n√£o encontrada');
            }
            
            // Testar recarregamento
            console.log('Testando recarregamento...');
            if (typeof loadDashboardData === 'function') {
                loadDashboardData();
            } else {
                console.error('Fun√ß√£o loadDashboardData n√£o encontrada');
            }
        };

        // üîß Fun√ß√£o de teste manual para filtros
        window.testDashboardFilter = function(month, year) {
            console.log(`üß™ Testando filtro: m√™s=${month}, ano=${year}`);
            
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            if (monthFilter && month) monthFilter.value = month;
            if (yearFilter && year) yearFilter.value = year;
            
            console.log('Filtros definidos, recarregando...');
            if (typeof loadDashboardData === 'function') {
                loadDashboardData();
            }
        };
        
        // üîß FUN√á√ÉO DEBUG: Testar fluxo de login/logout
        window.debugLoginLogout = function() {
            console.log('üîç === DEBUG LOGIN/LOGOUT ===');
            console.log('üë§ Current User:', currentUser);
            console.log('üè¢ User Units:', userUnits?.length || 0);
            console.log('üé≠ User Role:', userRole);
            console.log('üìã Available Modules:', availableModules?.length || 0);
            console.log('üíæ LocalStorage User:', localStorage.getItem('dromeflow_user') ? 'EXISTE' : 'VAZIO');
            console.log('üîì Login Overlay Display:', document.getElementById('loginOverlay')?.style.display);
            
            // Testar elementos da interface
            const userAvatar = document.querySelector('.user-avatar');
            const userName = document.querySelector('.user-name');
            const unitSelect = document.getElementById('unitSelect');
            
            console.log('üñºÔ∏è User Avatar:', userAvatar?.textContent || 'VAZIO');
            console.log('üë§ User Name:', userName?.textContent || 'VAZIO');
            console.log('üè¢ Unit Select Options:', unitSelect?.options?.length || 0);
            
            return {
                currentUser,
                userUnits: userUnits?.length || 0,
                userRole: userRole?.name,
                availableModules: availableModules?.length || 0,
                hasLocalStorage: !!localStorage.getItem('dromeflow_user'),
                loginOverlayVisible: document.getElementById('loginOverlay')?.style.display === 'flex'
            };
        };
        
        // üîß FUN√á√ÉO DEBUG: For√ßar reset completo
        window.forceResetSystem = function() {
            console.log('üîÑ For√ßando reset completo do sistema...');
            currentUser = null;
            userUnits = [];
            userRole = null;
            availableModules = [];
            unitModules = [];
            localStorage.removeItem('dromeflow_user');
            document.getElementById('loginOverlay').style.display = 'flex';
            console.log('‚úÖ Reset completo executado');
        };
    </script>
    
    <!-- Script de Valida√ß√£o CSS (apenas em desenvolvimento) -->
    <script src="js/css-validation.js"></script>

</body>
</html>
